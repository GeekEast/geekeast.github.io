<!DOCTYPE html>












  


<html class="theme-next pisces use-motion" lang>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">










  <meta name="google-site-verification" content="n6Y_FmNt0m-wUrpqzi4bnOH_dap6ns4L_afwT_535mo">











  
  
    
  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.6/jquery.fancybox.min.css">







  

<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.2/css/font-awesome.min.css">

<link rel="stylesheet" href="/css/main.css?v=7.0.1">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.0.1">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/developer.png?v=7.0.1">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/developer16.png?v=7.0.1">


  <link rel="mask-icon" href="/images/logo.svg?v=7.0.1" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '7.0.1',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: true,
    fastclick: false,
    lazyload: true,
    tabs: true,
    motion: {"enable":true,"async":true,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":5},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>




  




  <meta name="description" content="Introduction Install Node.js Run Node.js Node Module System NPM">
<meta name="keywords" content="Frontend,Restful API,Nodejs">
<meta property="og:type" content="article">
<meta property="og:title" content="Node.js 构建RESTful API">
<meta property="og:url" content="https://geekeast.github.io/nodeapi.html">
<meta property="og:site_name" content="雪中印">
<meta property="og:description" content="Introduction Install Node.js Run Node.js Node Module System NPM">
<meta property="og:locale" content="default">
<meta property="og:image" content="https://s3-ap-southeast-2.amazonaws.com/geekeaskblogpics/posts/2019-03-19-09-45-59.png">
<meta property="og:image" content="https://s3-ap-southeast-2.amazonaws.com/geekeaskblogpics/posts/2019-03-19-11-18-29.png">
<meta property="og:image" content="https://s3-ap-southeast-2.amazonaws.com/geekeaskblogpics/posts/2019-03-19-11-51-04.png">
<meta property="og:image" content="https://s3-ap-southeast-2.amazonaws.com/geekeaskblogpics/posts/2019-03-19-13-07-48.png">
<meta property="og:image" content="https://s3-ap-southeast-2.amazonaws.com/geekeaskblogpics/posts/WechatIMG2.jpeg">
<meta property="og:image" content="https://geekeaskblogpics.s3-ap-southeast-2.amazonaws.com/posts/WX20190602-220152.png">
<meta property="og:updated_time" content="2019-06-03T05:08:19.311Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Node.js 构建RESTful API">
<meta name="twitter:description" content="Introduction Install Node.js Run Node.js Node Module System NPM">
<meta name="twitter:image" content="https://s3-ap-southeast-2.amazonaws.com/geekeaskblogpics/posts/2019-03-19-09-45-59.png">






  <link rel="canonical" href="https://geekeast.github.io/nodeapi.html">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Node.js 构建RESTful API | 雪中印</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">雪中印</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <h1 class="site-subtitle" itemprop="description">心底清静方为道 退步原来是向前</h1>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Home</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archive">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archive</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>Categories</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>Tags</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>Search</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="Searching..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  
    <div class="reading-progress-bar"></div>
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://geekeast.github.io/nodeapi.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="James Tan">
      <meta itemprop="description" content="Sharing is the best way to learn.">
      <meta itemprop="image" content="/images/avatar.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="雪中印">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">Node.js 构建RESTful API

              
            
          </h2>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              

              
                
              

              <time title="Created: 2019-03-12 15:52:57" itemprop="dateCreated datePublished" datetime="2019-03-12T15:52:57+10:30">2019-03-12</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                <time title="Modified: 2019-06-03 14:38:19" itemprop="dateModified" datetime="2019-06-03T14:38:19+09:30">2019-06-03</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Backend/" itemprop="url" rel="index"><span itemprop="name">Backend</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="post-meta-item-icon" title="Views">
            <i class="fa fa-eye"></i>
            
            <span class="busuanzi-value" id="busuanzi_value_page_pv"></span>
            </span>
          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Symbols count in article: </span>
                
                <span title="Symbols count in article">59k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Reading time &asymp;</span>
                
                <span title="Reading time">43 mins.</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <ul>
<li>Introduction</li>
<li>Install Node.js</li>
<li>Run Node.js</li>
<li>Node Module System</li>
<li>NPM</li>
</ul>
<a id="more"></a>
<h2 id="introduction"><a class="markdownIt-Anchor" href="#introduction"></a> Introduction</h2>
<h3 id="what-is-nodejs"><a class="markdownIt-Anchor" href="#what-is-nodejs"></a> What is <code>Node.js</code>?</h3>
<blockquote>
<p>Running Environemnt for <code>Javascript</code> outside browsers, often used for create backend services - <code>API</code>. Node is ideal for building highly-scalable, data-insentive and real-time apps.</p>
</blockquote>
<ul>
<li>Easy to develop</li>
<li>Can be used for prototyping and agile development</li>
<li>Can be used in industry for large projects like Uber, Paypal, Netflix and Walmart.</li>
<li>Friendly for javascript programmers</li>
<li>Big community to support, libs</li>
</ul>
<h3 id="where-is-node-from"><a class="markdownIt-Anchor" href="#where-is-node-from"></a> Where is <code>Node</code> from?</h3>
<ul>
<li>extract the javascript engine from Chrome called <code>v8</code></li>
<li>integrate the <code>v8</code> with additional modules</li>
</ul>
<h3 id="asynchronous-in-nodejs"><a class="markdownIt-Anchor" href="#asynchronous-in-nodejs"></a> Asynchronous in Node.js</h3>
<ul>
<li>Synchronous by default in <span class="exturl" data-url="aHR0cDovL0FTUC5uZXQ=" title="http://ASP.net">ASP.net<i class="fa fa-external-link"></i></span></li>
<li>Asynchronous by default in nodejs</li>
<li>异步机制：使用<code>Event Queue</code>, 频繁检查, 执行任务</li>
</ul>
<h3 id="what-is-nodejs-used-for"><a class="markdownIt-Anchor" href="#what-is-nodejs-used-for"></a> What is Node.js used for?</h3>
<ul>
<li>Node is ideal for I/O Intensive Applications.</li>
<li>Node is not ideal for CPU Intensive Applications like <code>video encoding</code> and <code>image processing</code> applications.</li>
</ul>
<hr>
<h2 id="install-nodejs"><a class="markdownIt-Anchor" href="#install-nodejs"></a> Install Node.js</h2>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 也可以下载mac安装包</span></span><br><span class="line">brew install node</span><br><span class="line"><span class="meta">#</span><span class="bash"> 查看版本</span></span><br><span class="line">node --version</span><br></pre></td></tr></table></figure>
<h2 id="run-nodejs"><a class="markdownIt-Anchor" href="#run-nodejs"></a> Run Node.js</h2>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cd workspace</span><br><span class="line">mkdir newApp</span><br><span class="line">cd newApp</span><br><span class="line">code . # use VS code</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> create js file and run</span></span><br><span class="line">node app.js # for example</span><br></pre></td></tr></table></figure>
<ul>
<li>Code Example</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">hello = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'hello world'</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">hello(); <span class="comment">// vscode execute through node automatically</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="built_in">window</span>) <span class="comment">// error</span></span><br><span class="line"><span class="comment">// no window in node, that's for browser.</span></span><br></pre></td></tr></table></figure>
<hr>
<h2 id="javascript-module"><a class="markdownIt-Anchor" href="#javascript-module"></a> Javascript Module</h2>
<h3 id="global-object"><a class="markdownIt-Anchor" href="#global-object"></a> Global object</h3>
<blockquote>
<p>object that we can access everywhere, there is an object called <code>global</code>.</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">global.console.log(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">global.setTimeout();</span><br><span class="line">global.clearTimeout();</span><br><span class="line"></span><br><span class="line">global.setInterval();</span><br><span class="line">global.clearInterval();</span><br></pre></td></tr></table></figure>
<ul>
<li>But in browser, the <code>global</code> obejct is the <code>window</code> object.</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">window</span>.console.log(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">window</span>.setTimeout();</span><br><span class="line"><span class="built_in">window</span>.clearTimeout();</span><br><span class="line"></span><br><span class="line"><span class="built_in">window</span>.setInterval();</span><br><span class="line"><span class="built_in">window</span>.clearInterval();</span><br></pre></td></tr></table></figure>
<ul>
<li>And we can just simplify it in whichever env.</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">setTimeout();</span><br><span class="line">clearTimeout();</span><br><span class="line"></span><br><span class="line">setInterval();</span><br><span class="line">clearInterval();</span><br></pre></td></tr></table></figure>
<ul>
<li>But if you design your own obejct, it doesn’t belongs to <code>global</code> obejct. <code>node different global and local</code></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> message = <span class="string">"hello"</span>;</span><br><span class="line"><span class="built_in">console</span>.log(global.message);<span class="comment">// undefinded error</span></span><br></pre></td></tr></table></figure>
<ul>
<li>However it belongs to <code>window</code> if you use the browser rather than node. <code>window literally eat all food all things belong to window.</code></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> message = <span class="string">'hello'</span>;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="built_in">window</span>.message);</span><br></pre></td></tr></table></figure>
<hr>
<h3 id="insights-why-we-need-to-use-module"><a class="markdownIt-Anchor" href="#insights-why-we-need-to-use-module"></a> Insights: Why we need to use Module?</h3>
<ul>
<li>Node is better. Browser is worse.</li>
<li>Two js run in browser, with two variables or methods of the same name, the later one will override the previous one.</li>
<li>
<blockquote>
<p>Therefore, we use module to <code>localize</code> variables to avoid <code>collapse</code>.</p>
</blockquote>
</li>
</ul>
<blockquote>
<p><strong>在浏览器中，所有变量和方法都属于window</strong><br>
<strong>在Node中，如非特别定义，所有变量和方法都属于自己所在的文件，而不属于global</strong></p>
</blockquote>
<hr>
<h3 id="module-import-and-export"><a class="markdownIt-Anchor" href="#module-import-and-export"></a> Module Import and Export</h3>
<ul>
<li>Module like <strong><code>private</code></strong> in Java</li>
<li>Export <strong><code>module.exports.log = log</code></strong></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ./logger.js</span></span><br><span class="line"><span class="keyword">var</span> url = <span class="string">"http://www.example.com/login"</span>;</span><br><span class="line">log = <span class="function">(<span class="params">m</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(m)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// export the log function as log.</span></span><br><span class="line"><span class="built_in">module</span>.exports.log = log;</span><br><span class="line"></span><br><span class="line"><span class="comment">// export single function </span></span><br><span class="line"><span class="built_in">module</span>.exports = log;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Or</span></span><br><span class="line">moduel.exports = &#123;</span><br><span class="line">    log: log,</span><br><span class="line">    url: url</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>Import <strong><code>const {log, url} = require('./logger')</code></strong></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Way One</span></span><br><span class="line"><span class="keyword">const</span> logger = <span class="built_in">require</span>(<span class="string">'./logger'</span>) <span class="comment">// const is better</span></span><br><span class="line"><span class="comment">// execute the log method</span></span><br><span class="line">logger.log();</span><br><span class="line"></span><br><span class="line"><span class="comment">// Way Two - better, more lightweight</span></span><br><span class="line"><span class="keyword">const</span> &#123;log, url&#125; = <span class="built_in">require</span>(<span class="string">'./logger'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// If it is a single function</span></span><br><span class="line"><span class="comment">// module.exports = log;</span></span><br><span class="line"><span class="keyword">const</span> log = <span class="built_in">require</span>(<span class="string">'./logger'</span>);</span><br><span class="line">log(<span class="string">"hello"</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li><code>'./logger'</code> vs <code>'logger'</code>
<ul>
<li><code>'./logger'</code>: Current Ddirectory</li>
<li><code>'logger'</code>:
<ul>
<li>
<ol>
<li>Built in</li>
</ol>
</li>
<li>
<ol start="2">
<li>Current Directory</li>
</ol>
</li>
<li>
<ol start="3">
<li>in node_modules</li>
</ol>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="node-wrapper"><a class="markdownIt-Anchor" href="#node-wrapper"></a> Node Wrapper</h3>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">(<span class="function"><span class="keyword">function</span> (<span class="params">exports, require, module, __filename, __dirname</span>) </span>&#123; </span><br><span class="line">   <span class="comment">// file code</span></span><br><span class="line">   <span class="built_in">console</span>.log(exports);</span><br><span class="line">   <span class="built_in">console</span>.log(<span class="built_in">require</span>);</span><br><span class="line">   <span class="built_in">console</span>.log(<span class="built_in">module</span>);</span><br><span class="line">   <span class="built_in">console</span>.log(__filename);</span><br><span class="line">   <span class="built_in">console</span>.log(__dirname);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="node-modules-api"><a class="markdownIt-Anchor" href="#node-modules-api"></a> Node Modules API</h3>
<p><span class="exturl" data-url="aHR0cHM6Ly9ub2RlanMub3JnL2Rpc3QvbGF0ZXN0LXYxMC54L2RvY3MvYXBpLw==" title="https://nodejs.org/dist/latest-v10.x/docs/api/">Docs<i class="fa fa-external-link"></i></span></p>
<ul>
<li>File System</li>
<li>HTTP</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"><span class="keyword">const</span> server = http.createServer();</span><br><span class="line"></span><br><span class="line"><span class="comment">// action after connection event</span></span><br><span class="line">server.on(<span class="string">'connection'</span>,(<span class="function"><span class="params">s</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">"new connection."</span>))); <span class="comment">// very low level</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// port 3003</span></span><br><span class="line">server.listen(<span class="number">3003</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'Listening on port 3000...'</span>);</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">const</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> server = http.createServer(</span><br><span class="line">    (req,res) =&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (req.url === <span class="string">'/'</span>)&#123;</span><br><span class="line">            res.write(<span class="string">"hello world"</span>);</span><br><span class="line">            res.end();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (req.url === <span class="string">'/api'</span>) &#123;</span><br><span class="line">            res.write(<span class="built_in">JSON</span>.stringify(&#123;</span><br><span class="line">                <span class="string">"1"</span>:<span class="number">2</span></span><br><span class="line">            &#125;));</span><br><span class="line">            res.end();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">);</span><br><span class="line"><span class="comment">// port 3003</span></span><br><span class="line">server.listen(<span class="number">3003</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'Listening on port 3003...'</span>);</span><br></pre></td></tr></table></figure>
<ul>
<li>OS</li>
<li>Path</li>
<li>Process</li>
<li>Query Strings</li>
<li>Stream</li>
</ul>
<h2 id="npm"><a class="markdownIt-Anchor" href="#npm"></a> NPM</h2>
<h3 id="create-npm-project"><a class="markdownIt-Anchor" href="#create-npm-project"></a> Create NPM Project</h3>
<h4 id="switch-version-of-npm"><a class="markdownIt-Anchor" href="#switch-version-of-npm"></a> Switch Version of npm</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo npm i -g npm@5.5.1</span><br></pre></td></tr></table></figure>
<h4 id="create-packagejson-file"><a class="markdownIt-Anchor" href="#create-packagejson-file"></a> Create <code>package.json</code> file</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npm init</span><br><span class="line"><span class="meta">#</span><span class="bash"> default settings</span></span><br><span class="line">npm init --yes</span><br></pre></td></tr></table></figure>
<h4 id="install-node-package"><a class="markdownIt-Anchor" href="#install-node-package"></a> Install Node Package</h4>
<ul>
<li>package is installed in <code>node_modules</code></li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">npm install underscore</span><br><span class="line"><span class="meta">#</span><span class="bash"> shorter</span></span><br><span class="line">npm i underscore</span><br><span class="line"><span class="meta">#</span><span class="bash"> you don<span class="string">'t have to add --save anyore</span></span></span><br></pre></td></tr></table></figure>
<ul>
<li>A better way <strong><code>yarn</code></strong></li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yarn add underscore</span><br><span class="line">yarn remove underscore</span><br></pre></td></tr></table></figure>
<ul>
<li>install all package in <code>package.json</code></li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yarn</span><br><span class="line"><span class="meta">#</span><span class="bash"> or</span></span><br><span class="line">npm i</span><br></pre></td></tr></table></figure>
<h4 id="git-ignore-packages-to-push"><a class="markdownIt-Anchor" href="#git-ignore-packages-to-push"></a> Git Ignore Packages to Push</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">git init</span><br><span class="line">touch .gitignore</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># inside .gitignore</span></span></span><br><span class="line">node_modules/</span><br><span class="line"></span><br><span class="line">git add .</span><br><span class="line">git commit -m "..."</span><br><span class="line">git push</span><br></pre></td></tr></table></figure>
<h4 id="underscorejs"><a class="markdownIt-Anchor" href="#underscorejs"></a> Underscore.js</h4>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> _ = <span class="built_in">require</span>(<span class="string">'underscore'</span>);</span><br><span class="line"><span class="built_in">console</span>.log(_.contains([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>],<span class="number">2</span>))</span><br></pre></td></tr></table></figure>
<h4 id="semantic-versioning"><a class="markdownIt-Anchor" href="#semantic-versioning"></a> Semantic Versioning</h4>
<ul>
<li>
<p>4.13.6</p>
<ul>
<li>(Patch) 6: bugs fixing version</li>
<li>(Minor) 13: new features version without breaking exsiting API</li>
<li>(Main) 4: new features version with breaking existing application</li>
</ul>
</li>
<li>
<p>exact version : <code>4.13.6</code></p>
</li>
<li>
<p>stable Major and Minor: <code>~4.13.6</code></p>
</li>
<li>
<p>stable Major: <code>^4.13.6</code></p>
</li>
</ul>
<h4 id="inspect-installed-versions"><a class="markdownIt-Anchor" href="#inspect-installed-versions"></a> Inspect installed versions</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">yarn list</span><br><span class="line">yarn list --depth=0</span><br><span class="line"><span class="meta">#</span><span class="bash"> 效果是不一样的</span></span><br><span class="line">npm list</span><br><span class="line">npm list --depth=0</span><br></pre></td></tr></table></figure>
<h4 id="view-packages"><a class="markdownIt-Anchor" href="#view-packages"></a> View Packages</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">npm view mongoose</span><br><span class="line">npm view mongoose dependencies</span><br></pre></td></tr></table></figure>
<h4 id="update-outdated-packages"><a class="markdownIt-Anchor" href="#update-outdated-packages"></a> Update outdated packages</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">npm outdated</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> this will only update minor and patch update</span></span><br><span class="line">npm update</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> update <span class="keyword">for</span> major update</span></span><br><span class="line">sudo npm i -g npm-check-updates</span><br><span class="line">ncu -u # to upgrade the json file</span><br><span class="line">yarn # execute the update</span><br></pre></td></tr></table></figure>
<h4 id="install-packages-only-for-dev"><a class="markdownIt-Anchor" href="#install-packages-only-for-dev"></a> Install Packages only for Dev</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i jshint --save-dev</span><br></pre></td></tr></table></figure>
<h4 id="uninstall-packages"><a class="markdownIt-Anchor" href="#uninstall-packages"></a> Uninstall Packages</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npm un mongoose</span><br><span class="line"><span class="meta">#</span><span class="bash"> or</span></span><br><span class="line">yarn remove mongoose</span><br></pre></td></tr></table></figure>
<h3 id="global-packages"><a class="markdownIt-Anchor" href="#global-packages"></a> Global Packages</h3>
<ul>
<li>Global: can be used under any folders</li>
<li>Local: can only be used withon on folder</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> update the npm to the latest version</span></span><br><span class="line">sudo npm i -g npm</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> to see all outdated global packages</span></span><br><span class="line">npm -g outdated</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> uninstall global packages</span></span><br><span class="line">npm un -g npm</span><br></pre></td></tr></table></figure>
<h3 id="npm-registry"><a class="markdownIt-Anchor" href="#npm-registry"></a> NPM Registry</h3>
<h4 id="publish-your-own-package-to-npm-registry"><a class="markdownIt-Anchor" href="#publish-your-own-package-to-npm-registry"></a> Publish Your Own Package to NPM Registry</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> prepare the project</span></span><br><span class="line">mkdir lion-lib</span><br><span class="line">cd lion-lib/</span><br><span class="line">npm init --yes</span><br><span class="line">touch index.js</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.js</span></span><br><span class="line"><span class="built_in">module</span>.exports.url = <span class="string">"asdadsad"</span></span><br></pre></td></tr></table></figure>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> register <span class="keyword">for</span> registry</span></span><br><span class="line">npm adduser</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> login</span></span><br><span class="line">npm login</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> make sure your package name is unique <span class="keyword">in</span> the pacakge.json file and the push to the registry</span></span><br><span class="line">npm publish</span><br></pre></td></tr></table></figure>
<h4 id="updating-your-published-packages"><a class="markdownIt-Anchor" href="#updating-your-published-packages"></a> Updating your Published Packages</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> first you have to update the versio number</span></span><br><span class="line">npm version major</span><br><span class="line">npm version minor</span><br><span class="line">npn version patch</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="keyword">then</span> publish to the registry</span></span><br><span class="line">npm publish</span><br></pre></td></tr></table></figure>
<h2 id="restful-service"><a class="markdownIt-Anchor" href="#restful-service"></a> RESTful Service</h2>
<h3 id="rest-definition"><a class="markdownIt-Anchor" href="#rest-definition"></a> REST Definition</h3>
<blockquote>
<p>REST: Representational State Transfer<br>
It’s a <code>convention</code> for building these HTTP serivces.</p>
</blockquote>
<h3 id="http-protocol"><a class="markdownIt-Anchor" href="#http-protocol"></a> HTTP Protocol</h3>
<table>
    <tr>
        <td bgcolor="blue">
            <center>
                <font color="orange" size="5">
                    Http://vidly.com/api/customers/1
                </font>
            </center>
        </td>
    </tr>
</table>
<ul>
<li><code>Http</code>: Protocol</li>
<li><code>vidly.com</code>: Domain</li>
<li><code>api</code>: Path</li>
<li><code>customers</code>: Resource</li>
<li><code>1</code>: Resource Unique Identifier</li>
</ul>
<h3 id="http-methods"><a class="markdownIt-Anchor" href="#http-methods"></a> HTTP Methods</h3>
<ul>
<li>GET: retrive resources</li>
<li>POST: upload resources</li>
<li>PUT: update global resources</li>
<li>PATCH: update local resources</li>
<li>DELETE: delete resources</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">GET /api/customers</span><br><span class="line">GET /api/customers/<span class="number">1</span></span><br><span class="line">PUT /api/customers/<span class="number">1</span></span><br><span class="line">DELETE /api/customers/<span class="number">1</span></span><br><span class="line">POST /api/customers</span><br></pre></td></tr></table></figure>
<h2 id="node-monitor"><a class="markdownIt-Anchor" href="#node-monitor"></a> Node Monitor</h2>
<blockquote>
<p>Reload the Node Automatically when changes apply.</p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo npm i -g nodemon</span><br><span class="line"><span class="meta">#</span><span class="bash"> instead of node app.js</span></span><br><span class="line">nodemon app.js</span><br><span class="line"><span class="meta">#</span><span class="bash"> listen to customized file types.</span></span><br><span class="line">nodemon -e .yml,.js app.js</span><br></pre></td></tr></table></figure>
<ul>
<li>在配置vscode code runner为nodemon之后，nodemon失效</li>
<li>shell中<code>nodemon app.js</code>, nodemon不会失效.</li>
<li>推荐使用shell的方式</li>
</ul>
<h2 id="express-basics"><a class="markdownIt-Anchor" href="#express-basics"></a> Express Basics</h2>
<h3 id="get-to-know-express"><a class="markdownIt-Anchor" href="#get-to-know-express"></a> Get to know express</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> inspect it <span class="keyword">in</span> shell</span></span><br><span class="line">npm view express</span><br><span class="line"><span class="meta">#</span><span class="bash"> get the official website</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> http://expressjs.com/</span></span><br></pre></td></tr></table></figure>
<h3 id="install-express"><a class="markdownIt-Anchor" href="#install-express"></a> Install Express</h3>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add express</span><br></pre></td></tr></table></figure>
<h3 id="routes"><a class="markdownIt-Anchor" href="#routes"></a> <span class="exturl" data-url="aHR0cHM6Ly9leHByZXNzanMuY29tL3poLWNuL2d1aWRlL3JvdXRpbmcuaHRtbA==" title="https://expressjs.com/zh-cn/guide/routing.html">Routes<i class="fa fa-external-link"></i></span></h3>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.METHOD(URL,CALLBACK_FUNC)</span><br></pre></td></tr></table></figure>
<h3 id="example"><a class="markdownIt-Anchor" href="#example"></a> Example</h3>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Import express and initialize an app</span></span><br><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">var</span> app = express();</span><br><span class="line"><span class="keyword">var</span> port = process.env.PORT || <span class="number">3000</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Set routes</span></span><br><span class="line">app.get(<span class="string">'/'</span>,(req, res) =&gt; &#123;</span><br><span class="line">  res.send(<span class="string">"Hello World"</span>)</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// start listen</span></span><br><span class="line">app.listen(port);</span><br></pre></td></tr></table></figure>
<p><span class="exturl" data-url="aHR0cDovL3d3dy5leHByZXNzanMuY29tLmNuLzR4L2FwaS5odG1sI3JlcQ==" title="http://www.expressjs.com.cn/4x/api.html#req"><code>Req Method</code><i class="fa fa-external-link"></i></span></p>
<table>
<thead>
<tr>
<th style="text-align:left">Method</th>
<th style="text-align:left">Description</th>
<th style="text-align:left">Example</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">req.get()</td>
<td style="text-align:left">获取header中某属性的值</td>
<td style="text-align:left"><code>req.get('Content-type')</code></td>
</tr>
<tr>
<td style="text-align:left"><code>req.is()</code></td>
<td style="text-align:left">判别来的body的Content-Type</td>
<td style="text-align:left"><code>req.is(html)</code></td>
</tr>
</tbody>
</table>
<p><span class="exturl" data-url="aHR0cDovL3d3dy5leHByZXNzanMuY29tLmNuLzR4L2FwaS5odG1sI3JlcQ==" title="http://www.expressjs.com.cn/4x/api.html#req"><code>Req Properties</code><i class="fa fa-external-link"></i></span></p>
<table>
<thead>
<tr>
<th style="text-align:left">Property</th>
<th style="text-align:left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">req.body</td>
<td style="text-align:left">键值对数据</td>
</tr>
<tr>
<td style="text-align:left">req.cookies</td>
<td style="text-align:left">获取cookies</td>
</tr>
<tr>
<td style="text-align:left">req.hostname</td>
<td style="text-align:left">获取域名</td>
</tr>
<tr>
<td style="text-align:left">req.ip</td>
<td style="text-align:left">获取ip</td>
</tr>
<tr>
<td style="text-align:left">req.method</td>
<td style="text-align:left">获取方法</td>
</tr>
<tr>
<td style="text-align:left">req.originalUrl</td>
<td style="text-align:left">完整url</td>
</tr>
<tr>
<td style="text-align:left">req.baseUrl</td>
<td style="text-align:left">路由插入的路径</td>
</tr>
<tr>
<td style="text-align:left">req.path</td>
<td style="text-align:left">细节路径</td>
</tr>
<tr>
<td style="text-align:left">req.params</td>
<td style="text-align:left">存储参数化数据</td>
</tr>
<tr>
<td style="text-align:left">req.protocol</td>
<td style="text-align:left">http/https</td>
</tr>
<tr>
<td style="text-align:left"><code>req.query</code></td>
<td style="text-align:left"><strong>获取url中?间所夹参数</strong></td>
</tr>
</tbody>
</table>
<p><span class="exturl" data-url="aHR0cDovL3d3dy5leHByZXNzanMuY29tLmNuLzR4L2FwaS5odG1sI3Jlcw==" title="http://www.expressjs.com.cn/4x/api.html#res"><code>Res Method</code><i class="fa fa-external-link"></i></span></p>
<table>
<thead>
<tr>
<th style="text-align:left">Method</th>
<th style="text-align:left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">res.download()</td>
<td style="text-align:left">提示将要下载文件。</td>
</tr>
<tr>
<td style="text-align:left">res.end()</td>
<td style="text-align:left">结束响应进程。</td>
</tr>
<tr>
<td style="text-align:left">res.json()</td>
<td style="text-align:left">发送 JSON 响应。</td>
</tr>
<tr>
<td style="text-align:left">res.jsonp()</td>
<td style="text-align:left">在 JSONP 的支持下发送 JSON 响应。</td>
</tr>
<tr>
<td style="text-align:left">res.redirect()</td>
<td style="text-align:left">重定向请求。</td>
</tr>
<tr>
<td style="text-align:left">res.render()</td>
<td style="text-align:left">呈现视图模板。</td>
</tr>
<tr>
<td style="text-align:left">res.send()</td>
<td style="text-align:left">发送各种类型的响应。</td>
</tr>
<tr>
<td style="text-align:left">res.sendFile</td>
<td style="text-align:left">以八位元流形式发送文件。</td>
</tr>
<tr>
<td style="text-align:left">res.sendStatus()</td>
<td style="text-align:left">设置响应状态码并以响应主体形式发送其字符串表示。</td>
</tr>
</tbody>
</table>
<h3 id="middleware-routes"><a class="markdownIt-Anchor" href="#middleware-routes"></a> <span class="exturl" data-url="aHR0cHM6Ly9leHByZXNzanMuY29tL2VuL2d1aWRlL3JvdXRpbmcuaHRtbA==" title="https://expressjs.com/en/guide/routing.html">Middleware Routes<i class="fa fa-external-link"></i></span></h3>
<p><code>统一请求中间件：适合做User Authentication</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Import express and initialize an app</span></span><br><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">var</span> app = express();</span><br><span class="line"><span class="keyword">var</span> port = process.env.PORT || <span class="number">3000</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Set routes</span></span><br><span class="line">app.all(<span class="string">'/'</span>, (req,res,next) =&gt; &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'authentication'</span>);</span><br><span class="line">  next();</span><br><span class="line">&#125;);</span><br><span class="line">app.get(<span class="string">'/'</span>,(req, res) =&gt; &#123;</span><br><span class="line">  res.send(<span class="string">"How are you?"</span>)</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// start listen</span></span><br><span class="line">app.listen(port);</span><br></pre></td></tr></table></figure>
<p><code>单一路径多个回调</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// configure express</span></span><br><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">var</span> app = express();</span><br><span class="line"><span class="keyword">var</span> port = process.env.PORT || <span class="number">3000</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// routes</span></span><br><span class="line">app.route(<span class="string">"/"</span>).get(<span class="function">(<span class="params">req,res</span>)=&gt;</span> &#123;</span><br><span class="line">    res.send(<span class="string">"get test"</span>);</span><br><span class="line">&#125;).post(<span class="function">(<span class="params">req,res</span>)=&gt;</span> &#123;</span><br><span class="line">    res.send(<span class="string">"post test"</span>);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// listen</span></span><br><span class="line">app.listen(port);</span><br></pre></td></tr></table></figure>
<p><code>express.Router</code></p>
<blockquote>
<p>Use the express.Router class to create <strong>modular</strong>, <strong>mountable</strong> route handlers. A Router instance is a complete <strong>middleware</strong> and <strong>routing</strong> <strong>system</strong>; for this reason, it is often referred to as a “mini-app”.</p>
</blockquote>
<p><span class="exturl" data-url="aHR0cDovL3d3dy5leHByZXNzanMuY29tLmNuLzR4L2FwaS5odG1sI3JvdXRlci5hbGw=" title="http://www.expressjs.com.cn/4x/api.html#router.all"><code>Router Method</code><i class="fa fa-external-link"></i></span></p>
<table>
<thead>
<tr>
<th style="text-align:left">Method</th>
<th style="text-align:left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">router.all()</td>
<td style="text-align:left">匹配所有http请求，无中间件</td>
</tr>
<tr>
<td style="text-align:left">router.get()</td>
<td style="text-align:left">匹配GET请求</td>
</tr>
<tr>
<td style="text-align:left">router.param()</td>
<td style="text-align:left">匹配特定参数</td>
</tr>
<tr>
<td style="text-align:left">router.route()</td>
<td style="text-align:left">单一路径匹配多个回调</td>
</tr>
<tr>
<td style="text-align:left">router.use()</td>
<td style="text-align:left">匹配所有http请求, 添加中间件</td>
</tr>
</tbody>
</table>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// bird.js</span></span><br><span class="line"><span class="comment">// Import express and initialize an app</span></span><br><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">var</span> app = express();</span><br><span class="line"><span class="keyword">var</span> router = express.Router();  </span><br><span class="line"><span class="keyword">var</span> port = process.env.PORT || <span class="number">3000</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// middleware</span></span><br><span class="line">router.use(<span class="function">(<span class="params">req,res,next</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">"authentication"</span>);</span><br><span class="line">  next();</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">"/"</span>,(req,res) =&gt; &#123;</span><br><span class="line">  res.send(<span class="string">"main page."</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">router.post(<span class="string">"/"</span>,(req,res) =&gt; &#123;</span><br><span class="line">  res.send(<span class="string">"main post."</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">"/about"</span>, (req,res)=&gt;&#123;</span><br><span class="line">  res.send(<span class="string">"about page."</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// mount the middleware(router);</span></span><br><span class="line">app.use(<span class="string">'/'</span>,router);</span><br><span class="line"><span class="comment">// start listen</span></span><br><span class="line">app.listen(port);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports.router = router;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>route.use’s callback is a middleware</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// main.js</span></span><br><span class="line"><span class="keyword">var</span> &#123;router&#125; = <span class="built_in">require</span>(<span class="string">'./birds'</span>);</span><br><span class="line"><span class="comment">// birds is also a middleware</span></span><br><span class="line">app.use(<span class="string">'/birds'</span>, birds);</span><br><span class="line">app.listen(<span class="number">3000</span>);</span><br></pre></td></tr></table></figure>
<p><code>Parameter Route</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Import express and initialize an app</span></span><br><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">var</span> app = express();</span><br><span class="line"><span class="keyword">var</span> router = express.Router();</span><br><span class="line"><span class="keyword">var</span> port = process.env.PORT || <span class="number">3000</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// middleware</span></span><br><span class="line">router.use(<span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">'authentication'</span>);</span><br><span class="line">	next();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">'/'</span>, (req, res) =&gt; &#123;</span><br><span class="line">	res.send(<span class="string">'Main Page.'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//实际上 ： 充当了一个通配作用，通配规则如何，请看验证参数</span></span><br><span class="line">router.get(<span class="string">'/:id'</span>, (req, res) =&gt; &#123;</span><br><span class="line">	res.send(<span class="string">'id namespace.'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.post(<span class="string">'/'</span>, (req, res) =&gt; &#123;</span><br><span class="line">	res.send(<span class="string">'main post.'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">'/about'</span>, (req, res) =&gt; &#123;</span><br><span class="line">	res.send(<span class="string">'about page.'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// mount the middleware(router);</span></span><br><span class="line">app.use(<span class="string">'/'</span>, router);</span><br><span class="line"><span class="comment">// start listen</span></span><br><span class="line">app.listen(port);</span><br></pre></td></tr></table></figure>
<p><code>Parameter Check</code></p>
<blockquote>
<p>有時候我們會需要針對傳入的路由參數來進行篩選或驗證，例如檢查使用者所輸入的字串是否是合法的名稱，這時候就可以使用 .param() 這個專門用來處理參數的 middleware：</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Import express and initialize an app</span></span><br><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">var</span> app = express();</span><br><span class="line"><span class="keyword">var</span> router = express.Router();</span><br><span class="line"><span class="keyword">var</span> port = process.env.PORT || <span class="number">3000</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// middleware</span></span><br><span class="line">router.use(<span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">'authentication'</span>);</span><br><span class="line">	next();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">'/'</span>, (req, res) =&gt; &#123;</span><br><span class="line">	res.send(<span class="string">'Main Page.'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 位于路由之前，充当另外一个middleware</span></span><br><span class="line">router.param(<span class="string">'id'</span>, (req, res, next, id) =&gt; &#123;</span><br><span class="line">	<span class="comment">// validation logi here</span></span><br><span class="line">	<span class="built_in">console</span>.log(<span class="string">'valid id'</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// send back request</span></span><br><span class="line">	req.id = id;</span><br><span class="line">	next();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">'/:id/:name'</span>, (req, res) =&gt; &#123;</span><br><span class="line">	res.send(req.params);</span><br><span class="line">	<span class="comment">// res.send(req.params.name);</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.post(<span class="string">'/'</span>, (req, res) =&gt; &#123;</span><br><span class="line">	res.send(<span class="string">'main post.'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">'/about'</span>, (req, res) =&gt; &#123;</span><br><span class="line">	res.send(<span class="string">'about page.'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// mount the middleware(router);</span></span><br><span class="line">app.use(<span class="string">'/'</span>, router);</span><br><span class="line"><span class="comment">// start listen</span></span><br><span class="line">app.listen(port);</span><br></pre></td></tr></table></figure>
<h3 id="query-string-parameters"><a class="markdownIt-Anchor" href="#query-string-parameters"></a> Query String Parameters</h3>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">"express"</span>);</span><br><span class="line"><span class="keyword">var</span> app = express();</span><br><span class="line"><span class="keyword">var</span> router = express.Router();</span><br><span class="line"><span class="keyword">var</span> port = process.env.PORT || <span class="number">3000</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">router.use(<span class="function">(<span class="params">req,res,next</span>)=&gt;</span>&#123;</span><br><span class="line">    next();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">router.get(<span class="string">"/:id"</span>, (req,res) =&gt; &#123;</span><br><span class="line">    <span class="comment">// 对应？后面的query参数</span></span><br><span class="line">    <span class="comment">// 例如: localhost:3000/courses/1?sortBy=name, query中包含sortBy的key-value pair</span></span><br><span class="line">    res.send(req.query);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.use(<span class="string">"/courses"</span>,router);</span><br><span class="line">app.listen(port);</span><br></pre></td></tr></table></figure>
<h3 id="http-get-request"><a class="markdownIt-Anchor" href="#http-get-request"></a> HTTP Get Request</h3>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// http get request examples</span></span><br><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">"express"</span>);</span><br><span class="line"><span class="keyword">var</span> app = express();</span><br><span class="line"><span class="keyword">var</span> router = express.Router();</span><br><span class="line"><span class="keyword">var</span> port = process.env.PORT || <span class="number">3000</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> courses = [</span><br><span class="line">    &#123;<span class="attr">id</span>: <span class="number">1</span>, <span class="attr">name</span>: <span class="string">"Statistics"</span>&#125;,</span><br><span class="line">    &#123;<span class="attr">id</span>: <span class="number">2</span>, <span class="attr">name</span>: <span class="string">"Data Mining"</span>&#125;,</span><br><span class="line">    &#123;<span class="attr">id</span>: <span class="number">3</span>, <span class="attr">name</span>: <span class="string">"Public Policy"</span>&#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">router.use(<span class="function">(<span class="params">req,res,next</span>)=&gt;</span>&#123;</span><br><span class="line">    next();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">"/"</span>,(req,res)=&gt;&#123;</span><br><span class="line">    res.send(courses);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">router.get(<span class="string">"/:id"</span>, (req,res) =&gt; &#123;</span><br><span class="line">    <span class="comment">// array find</span></span><br><span class="line">    <span class="keyword">const</span> course = courses.find(<span class="function"><span class="params">c</span> =&gt;</span> c.id === <span class="built_in">parseInt</span>(req.params.id));</span><br><span class="line">    <span class="comment">// 404 response.</span></span><br><span class="line">    <span class="keyword">if</span> (!course) res.status(<span class="number">404</span>).send(<span class="string">"The course doesn't exist."</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// normal response</span></span><br><span class="line">    res.send(course);</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.use(<span class="string">"/courses"</span>,router);</span><br><span class="line">app.listen(port);</span><br></pre></td></tr></table></figure>
<h3 id="http-post-request"><a class="markdownIt-Anchor" href="#http-post-request"></a> HTTP Post Request</h3>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// http post request examples</span></span><br><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">"express"</span>);</span><br><span class="line"><span class="keyword">var</span> app = express();</span><br><span class="line"><span class="keyword">var</span> router = express.Router();</span><br><span class="line"><span class="keyword">var</span> port = process.env.PORT || <span class="number">3000</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> courses = [</span><br><span class="line">    &#123;<span class="attr">id</span>: <span class="number">1</span>, <span class="attr">name</span>: <span class="string">"Statistics"</span>&#125;,</span><br><span class="line">    &#123;<span class="attr">id</span>: <span class="number">2</span>, <span class="attr">name</span>: <span class="string">"Data Mining"</span>&#125;,</span><br><span class="line">    &#123;<span class="attr">id</span>: <span class="number">3</span>, <span class="attr">name</span>: <span class="string">"Public Policy"</span>&#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">router.use(<span class="function">(<span class="params">req,res,next</span>)=&gt;</span>&#123;</span><br><span class="line">    next();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">"/"</span>,(req,res)=&gt;&#123;</span><br><span class="line">    res.send(courses);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">router.post(<span class="string">"/"</span>, (req,res) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> course = &#123;</span><br><span class="line">        id: courses.length + <span class="number">1</span>,</span><br><span class="line">        name: req.body.name</span><br><span class="line">    &#125;</span><br><span class="line">    courses.push(course);</span><br><span class="line">    res.send(course);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">router.get(<span class="string">"/:id"</span>, (req,res) =&gt; &#123;</span><br><span class="line">    <span class="comment">// array find</span></span><br><span class="line">    <span class="keyword">const</span> course = courses.find(<span class="function"><span class="params">c</span> =&gt;</span> c.id === <span class="built_in">parseInt</span>(req.params.id));</span><br><span class="line">    <span class="comment">// 404 response.</span></span><br><span class="line">    <span class="keyword">if</span> (!course) res.status(<span class="number">404</span>).send(<span class="string">"The course doesn't exist."</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// normal response</span></span><br><span class="line">    res.send(course);</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// use the json middleware.</span></span><br><span class="line">app.use(express.json());</span><br><span class="line">app.use(<span class="string">"/courses"</span>,router);</span><br><span class="line">app.listen(port);</span><br></pre></td></tr></table></figure>
<h4 id="simple-input-validation"><a class="markdownIt-Anchor" href="#simple-input-validation"></a> Simple Input Validation</h4>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">"express"</span>);</span><br><span class="line"><span class="keyword">var</span> app = express();</span><br><span class="line"><span class="keyword">var</span> router = express.Router();</span><br><span class="line"><span class="keyword">var</span> port = process.env.PORT || <span class="number">3000</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> courses = [</span><br><span class="line">    &#123;<span class="attr">id</span>: <span class="number">1</span>, <span class="attr">name</span>: <span class="string">"Statistics"</span>&#125;,</span><br><span class="line">    &#123;<span class="attr">id</span>: <span class="number">2</span>, <span class="attr">name</span>: <span class="string">"Data Mining"</span>&#125;,</span><br><span class="line">    &#123;<span class="attr">id</span>: <span class="number">3</span>, <span class="attr">name</span>: <span class="string">"Public Policy"</span>&#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">router.use(<span class="function">(<span class="params">req,res,next</span>)=&gt;</span>&#123;</span><br><span class="line">    next();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">"/"</span>,(req,res)=&gt;&#123;</span><br><span class="line">    res.send(courses);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">router.post(<span class="string">"/"</span>, (req,res) =&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// validation - simple version</span></span><br><span class="line">    <span class="keyword">if</span> (! req.body.name || req.body.name.length &lt; <span class="number">3</span>)&#123;</span><br><span class="line">        res.status(<span class="number">400</span>).send(<span class="string">"Name is required and should be minimum 3 characters."</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> course = &#123;</span><br><span class="line">        id: courses.length + <span class="number">1</span>,</span><br><span class="line">        name: req.body.name</span><br><span class="line">    &#125;</span><br><span class="line">    courses.push(course);</span><br><span class="line">    res.send(course);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">router.get(<span class="string">"/:id"</span>, (req,res) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> course = courses.find(<span class="function"><span class="params">c</span> =&gt;</span> c.id === <span class="built_in">parseInt</span>(req.params.id));</span><br><span class="line">    <span class="keyword">if</span> (!course) res.status(<span class="number">404</span>).send(<span class="string">"The course doesn't exist."</span>);</span><br><span class="line">    res.send(course);</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">app.use(express.json());</span><br><span class="line">app.use(<span class="string">"/courses"</span>,router);</span><br><span class="line">app.listen(port);</span><br></pre></td></tr></table></figure>
<h4 id="complex-input-validation"><a class="markdownIt-Anchor" href="#complex-input-validation"></a> Complex Input Validation</h4>
<p><code>yarn add joi</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">"express"</span>);</span><br><span class="line"><span class="comment">// import joi</span></span><br><span class="line"><span class="keyword">const</span> Joi = <span class="built_in">require</span>(<span class="string">'joi'</span>)</span><br><span class="line"><span class="keyword">var</span> app = express();</span><br><span class="line"><span class="keyword">var</span> router = express.Router();</span><br><span class="line"><span class="keyword">var</span> port = process.env.PORT || <span class="number">3000</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> courses = [</span><br><span class="line">    &#123;<span class="attr">id</span>: <span class="number">1</span>, <span class="attr">name</span>: <span class="string">"Statistics"</span>&#125;,</span><br><span class="line">    &#123;<span class="attr">id</span>: <span class="number">2</span>, <span class="attr">name</span>: <span class="string">"Data Mining"</span>&#125;,</span><br><span class="line">    &#123;<span class="attr">id</span>: <span class="number">3</span>, <span class="attr">name</span>: <span class="string">"Public Policy"</span>&#125;</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">router.use(<span class="function">(<span class="params">req,res,next</span>)=&gt;</span>&#123;</span><br><span class="line">    next();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">"/"</span>,(req,res)=&gt;&#123;</span><br><span class="line">    res.send(courses);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">router.post(<span class="string">"/"</span>, (req,res) =&gt; &#123;</span><br><span class="line">    <span class="comment">// validation - joi version</span></span><br><span class="line">    <span class="keyword">const</span> schema = &#123;</span><br><span class="line">        name: Joi.string().min(<span class="number">3</span>).required(),</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> result = Joi.validate(req.body, schema);</span><br><span class="line">    <span class="keyword">if</span> (result.error)&#123;</span><br><span class="line">        res.status(<span class="number">400</span>).send(result.error.details[<span class="number">0</span>].message);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> course = &#123;</span><br><span class="line">        id: courses.length + <span class="number">1</span>,</span><br><span class="line">        name: req.body.name</span><br><span class="line">    &#125;</span><br><span class="line">    courses.push(course);</span><br><span class="line">    res.send(course);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">"/:id"</span>, (req,res) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> course = courses.find(<span class="function"><span class="params">c</span> =&gt;</span> c.id === <span class="built_in">parseInt</span>(req.params.id));</span><br><span class="line">    <span class="keyword">if</span> (!course) res.status(<span class="number">404</span>).send(<span class="string">"The course doesn't exist."</span>);</span><br><span class="line">    res.send(course);</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.use(express.json());</span><br><span class="line">app.use(<span class="string">"/courses"</span>,router);</span><br><span class="line">app.listen(port);</span><br></pre></td></tr></table></figure>
<h4 id="reqbody-vs-reqparams"><a class="markdownIt-Anchor" href="#reqbody-vs-reqparams"></a> req.body vs req.params</h4>
<ul>
<li>req.body里装的是post的data</li>
<li>req.params里装的是url中的某个值</li>
</ul>
<h3 id="http-update-request"><a class="markdownIt-Anchor" href="#http-update-request"></a> HTTP Update Request</h3>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="comment">// import joi</span></span><br><span class="line"><span class="keyword">const</span> Joi = <span class="built_in">require</span>(<span class="string">'joi'</span>);</span><br><span class="line"><span class="keyword">var</span> app = express();</span><br><span class="line"><span class="keyword">var</span> router = express.Router();</span><br><span class="line"><span class="keyword">var</span> port = process.env.PORT || <span class="number">3000</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> courses = [ &#123; <span class="attr">id</span>: <span class="number">1</span>, <span class="attr">name</span>: <span class="string">'Statistics'</span> &#125;, &#123; <span class="attr">id</span>: <span class="number">2</span>, <span class="attr">name</span>: <span class="string">'Data Mining'</span> &#125;, &#123; <span class="attr">id</span>: <span class="number">3</span>, <span class="attr">name</span>: <span class="string">'Public Policy'</span> &#125; ];</span><br><span class="line"></span><br><span class="line">router.use(<span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">	next();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// put method</span></span><br><span class="line">router.put(<span class="string">'/:id'</span>, (req, res) =&gt; &#123;</span><br><span class="line">	<span class="comment">// look up the course</span></span><br><span class="line">    <span class="keyword">let</span> course = courses.find(<span class="function">(<span class="params">c</span>) =&gt;</span> c.id === <span class="built_in">parseInt</span>(req.params.id));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// if no such course</span></span><br><span class="line">	<span class="keyword">if</span> (!course) &#123;</span><br><span class="line">		res.status(<span class="number">400</span>).send(<span class="string">'no such course.'</span>);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// if exist, validate</span></span><br><span class="line">	<span class="keyword">const</span> schema = &#123;</span><br><span class="line">		name: Joi.string().min(<span class="number">3</span>).required()</span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="keyword">const</span> result = Joi.validate(req.body, schema);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// validation fails</span></span><br><span class="line">	<span class="keyword">if</span> (result.error) &#123;</span><br><span class="line">		res.status(<span class="number">400</span>).send(result.error.details[<span class="number">0</span>].message);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// change data in place</span></span><br><span class="line">    course.name = req.body.name;</span><br><span class="line">    res.send(course);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">'/'</span>, (req, res) =&gt; &#123;</span><br><span class="line">	res.send(courses);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.post(<span class="string">'/'</span>, (req, res) =&gt; &#123;</span><br><span class="line">	<span class="keyword">const</span> schema = &#123;</span><br><span class="line">		name: Joi.string().min(<span class="number">3</span>).required()</span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="keyword">const</span> result = Joi.validate(req.body, schema);</span><br><span class="line">	<span class="keyword">if</span> (result.error) &#123;</span><br><span class="line">		res.status(<span class="number">400</span>).send(result.error.details[<span class="number">0</span>].message);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">const</span> course = &#123;</span><br><span class="line">		id: courses.length + <span class="number">1</span>,</span><br><span class="line">		name: req.body.name</span><br><span class="line">	&#125;;</span><br><span class="line">	courses.push(course);</span><br><span class="line">	res.send(course);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">'/:id'</span>, (req, res) =&gt; &#123;</span><br><span class="line">	<span class="keyword">const</span> course = courses.find(<span class="function">(<span class="params">c</span>) =&gt;</span> c.id === <span class="built_in">parseInt</span>(req.params.id));</span><br><span class="line">	<span class="keyword">if</span> (!course) res.status(<span class="number">404</span>).send(<span class="string">"The course doesn't exist."</span>);</span><br><span class="line">	res.send(course);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.use(express.json());</span><br><span class="line">app.use(<span class="string">'/courses'</span>, router);</span><br><span class="line">app.listen(port);</span><br></pre></td></tr></table></figure>
<h3 id="http-delete-request"><a class="markdownIt-Anchor" href="#http-delete-request"></a> HTTP Delete Request</h3>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="comment">// import joi</span></span><br><span class="line"><span class="keyword">const</span> Joi = <span class="built_in">require</span>(<span class="string">'joi'</span>);</span><br><span class="line"><span class="keyword">var</span> app = express();</span><br><span class="line"><span class="keyword">var</span> router = express.Router();</span><br><span class="line"><span class="keyword">var</span> port = process.env.PORT || <span class="number">3000</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> courses = [ &#123; <span class="attr">id</span>: <span class="number">1</span>, <span class="attr">name</span>: <span class="string">'Statistics'</span> &#125;, &#123; <span class="attr">id</span>: <span class="number">2</span>, <span class="attr">name</span>: <span class="string">'Data Mining'</span> &#125;, &#123; <span class="attr">id</span>: <span class="number">3</span>, <span class="attr">name</span>: <span class="string">'Public Policy'</span> &#125; ];</span><br><span class="line"></span><br><span class="line">router.use(<span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">	next();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// put method</span></span><br><span class="line">router.put(<span class="string">'/:id'</span>, (req, res) =&gt; &#123;</span><br><span class="line">	<span class="comment">// look up the course</span></span><br><span class="line">    <span class="keyword">let</span> course = courses.find(<span class="function">(<span class="params">c</span>) =&gt;</span> c.id === <span class="built_in">parseInt</span>(req.params.id));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// if no such course</span></span><br><span class="line">	<span class="keyword">if</span> (!course) &#123;</span><br><span class="line">		res.status(<span class="number">400</span>).send(<span class="string">'no such course.'</span>);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// if exist, validate</span></span><br><span class="line">	<span class="keyword">const</span> schema = &#123;</span><br><span class="line">		name: Joi.string().min(<span class="number">3</span>).required()</span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="keyword">const</span> result = Joi.validate(req.body, schema);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// validation fails</span></span><br><span class="line">	<span class="keyword">if</span> (result.error) &#123;</span><br><span class="line">		res.status(<span class="number">400</span>).send(result.error.details[<span class="number">0</span>].message);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// change data in place</span></span><br><span class="line">    course.name = req.body.name;</span><br><span class="line">    res.send(course);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">'/'</span>, (req, res) =&gt; &#123;</span><br><span class="line">	res.send(courses);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.post(<span class="string">'/'</span>, (req, res) =&gt; &#123;</span><br><span class="line">	<span class="keyword">const</span> schema = &#123;</span><br><span class="line">		name: Joi.string().min(<span class="number">3</span>).required()</span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="keyword">const</span> result = Joi.validate(req.body, schema);</span><br><span class="line">	<span class="keyword">if</span> (result.error) &#123;</span><br><span class="line">		res.status(<span class="number">400</span>).send(result.error.details[<span class="number">0</span>].message);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">const</span> course = &#123;</span><br><span class="line">		id: courses.length + <span class="number">1</span>,</span><br><span class="line">		name: req.body.name</span><br><span class="line">	&#125;;</span><br><span class="line">	courses.push(course);</span><br><span class="line">	res.send(course);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">'/:id'</span>, (req, res) =&gt; &#123;</span><br><span class="line">	<span class="keyword">const</span> course = courses.find(<span class="function">(<span class="params">c</span>) =&gt;</span> c.id === <span class="built_in">parseInt</span>(req.params.id));</span><br><span class="line">	<span class="keyword">if</span> (!course) res.status(<span class="number">404</span>).send(<span class="string">"The course doesn't exist."</span>);</span><br><span class="line">	res.send(course);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">router.delete(<span class="string">"/:id"</span>, (req,res) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> course = courses.find(<span class="function"><span class="params">c</span> =&gt;</span>  c.id === <span class="built_in">parseInt</span>(req.params.id));</span><br><span class="line">    <span class="keyword">if</span> (!course) &#123;</span><br><span class="line">        res.status(<span class="number">404</span>).send(<span class="string">"Course doesn't exsit."</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// this happens in place</span></span><br><span class="line">    courses.splice(courses.indexOf(course),<span class="number">1</span>);</span><br><span class="line">    res.send(course);</span><br><span class="line"></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.use(express.json());</span><br><span class="line">app.use(<span class="string">'/courses'</span>, router);</span><br><span class="line">app.listen(port);</span><br></pre></td></tr></table></figure>
<h2 id="code-one-genre-vidly"><a class="markdownIt-Anchor" href="#code-one-genre-vidly"></a> Code One Genre: Vidly</h2>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> express = <span class="built_in">require</span>(<span class="string">"express"</span>);</span><br><span class="line"><span class="comment">// for json validation</span></span><br><span class="line"><span class="keyword">var</span> Joi = <span class="built_in">require</span>(<span class="string">"joi"</span>);</span><br><span class="line"><span class="keyword">var</span> app = express();</span><br><span class="line"><span class="keyword">var</span> port = process.env.PORT || <span class="number">3000</span>;</span><br><span class="line"><span class="keyword">var</span> router = express.Router();</span><br><span class="line"></span><br><span class="line"><span class="comment">// data part</span></span><br><span class="line"><span class="keyword">const</span> genres = [</span><br><span class="line">    &#123;<span class="attr">id</span>: <span class="number">1</span>, <span class="attr">name</span>: <span class="string">"Comedy"</span>&#125;,</span><br><span class="line">    &#123;<span class="attr">id</span>: <span class="number">2</span>, <span class="attr">name</span>: <span class="string">"Fantasy"</span>&#125;,</span><br><span class="line">    &#123;<span class="attr">id</span>: <span class="number">3</span>, <span class="attr">name</span>: <span class="string">"Horror"</span>&#125;,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment">// list all genres</span></span><br><span class="line">router.get(<span class="string">"/"</span>, (req,res) =&gt; &#123;</span><br><span class="line">    res.send(genres);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// GET request</span></span><br><span class="line">router.get(<span class="string">"/:id"</span>, (req,res) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> genre = genres.find(<span class="function"><span class="params">c</span> =&gt;</span> c.id === <span class="built_in">parseInt</span>(req.params.id));</span><br><span class="line">    <span class="keyword">if</span>(!genre)&#123;</span><br><span class="line">        res.status(<span class="number">404</span>).send(<span class="string">"genre doesn't exist."</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    res.send(genre);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// POST request</span></span><br><span class="line">router.post(<span class="string">'/'</span>, (req, res) =&gt; &#123;</span><br><span class="line">    <span class="comment">// validation</span></span><br><span class="line">    <span class="keyword">const</span> schema = &#123;</span><br><span class="line">        name: Joi.string().required()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> result = Joi.validate(req.body,schema);</span><br><span class="line">    <span class="keyword">if</span> (result.error)&#123;</span><br><span class="line">        res.status(<span class="number">400</span>).send(result.error.details[<span class="number">0</span>].message);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// update the data</span></span><br><span class="line">    <span class="keyword">const</span> genre = &#123;</span><br><span class="line">        id: genres.length + <span class="number">1</span>,</span><br><span class="line">        name: req.body.name</span><br><span class="line">    &#125;;</span><br><span class="line">    genres.push(genre);</span><br><span class="line">    res.send(genre);</span><br><span class="line">    <span class="built_in">console</span>.log(genres);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// PUT request</span></span><br><span class="line">router.put(<span class="string">"/:id"</span>, (req,res) =&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// find the genre</span></span><br><span class="line">    <span class="keyword">const</span> genre = genres.find(<span class="function"><span class="params">c</span> =&gt;</span> c.id === <span class="built_in">parseInt</span>(req.params.id));</span><br><span class="line">    <span class="keyword">if</span> (!genre)&#123;</span><br><span class="line">        res.status(<span class="number">404</span>).send(<span class="string">"Genre not found."</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// validation</span></span><br><span class="line">    <span class="keyword">const</span> schema = &#123;</span><br><span class="line">        name: Joi.string().required()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> result = Joi.validate(req.body, schema);</span><br><span class="line">    <span class="keyword">if</span> (result.error)&#123;</span><br><span class="line">        res.status(<span class="number">400</span>).send(result.error.details[<span class="number">0</span>].message);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// modify the data</span></span><br><span class="line">    genre.name = req.body.name;</span><br><span class="line">    res.send(genre);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// DELETE request</span></span><br><span class="line">router.delete(<span class="string">"/:id"</span>, (req,res)=&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> genre = genres.find(<span class="function"><span class="params">c</span> =&gt;</span> c.id === <span class="built_in">parseInt</span>(req.params.id));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!genre)&#123;</span><br><span class="line">        res.status(<span class="number">404</span>).send(<span class="string">"genre not found."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    genres.splice(genres.indexOf(genre), <span class="number">1</span>);</span><br><span class="line">    res.send(genre);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// for parsing json object</span></span><br><span class="line">app.use(express.json());</span><br><span class="line">app.use(<span class="string">"/api/genres"</span>,router);</span><br><span class="line">app.listen(port);</span><br></pre></td></tr></table></figure>
<h2 id="advanced-express"><a class="markdownIt-Anchor" href="#advanced-express"></a> Advanced Express</h2>
<h3 id="middleware"><a class="markdownIt-Anchor" href="#middleware"></a> Middleware</h3>
<blockquote>
<p>Middleware:  modular and mountable component</p>
</blockquote>
<h4 id="custom-middleware-function"><a class="markdownIt-Anchor" href="#custom-middleware-function"></a> Custom Middleware function</h4>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// middleware function</span></span><br><span class="line">router.use(<span class="function">(<span class="params">req,res,next</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// sth you want to do.</span></span><br><span class="line">    next();</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h4 id="build-in-middlware"><a class="markdownIt-Anchor" href="#build-in-middlware"></a> Build-in Middlware</h4>
<ul>
<li>the url encoded middleware<br>
<img src="https://s3-ap-southeast-2.amazonaws.com/geekeaskblogpics/posts/2019-03-19-09-45-59.png" alt></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.use(express.urlencoded(&#123;<span class="attr">extended</span>: <span class="literal">true</span>&#125;))</span><br></pre></td></tr></table></figure>
<ul>
<li>the static resouces hosting middleware<br>
<img src="https://s3-ap-southeast-2.amazonaws.com/geekeaskblogpics/posts/2019-03-19-11-18-29.png" alt></li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// static files hosted in "./public" folder</span></span><br><span class="line"><span class="comment">// access by localhost:3000/filename.</span></span><br><span class="line">app.use(express.static(<span class="string">"public"</span>));</span><br></pre></td></tr></table></figure>
<h4 id="third-party-middleware"><a class="markdownIt-Anchor" href="#third-party-middleware"></a> Third Party Middleware</h4>
<p><span class="exturl" data-url="aHR0cHM6Ly9leHByZXNzanMuY29tL2VuL3Jlc291cmNlcy9taWRkbGV3YXJlLmh0bWw=" title="https://expressjs.com/en/resources/middleware.html">Resources<i class="fa fa-external-link"></i></span></p>
<blockquote>
<p>the performance matters.</p>
</blockquote>
<ul>
<li>helmet - https</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i helmet</span><br></pre></td></tr></table></figure>
<div class="note warning">
            <p>The helmet test failed.</p>
          </div>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> helmet = <span class="built_in">require</span>(<span class="string">'helmet'</span>)</span><br><span class="line">app.use(helmet()) <span class="comment">// as early as possible.</span></span><br></pre></td></tr></table></figure>
<ul>
<li>morgan - console logger</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i morgan</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> morgan = <span class="built_in">require</span>(<span class="string">'morgan'</span>);</span><br><span class="line">app.use(morgan(tiny));</span><br></pre></td></tr></table></figure>
<h3 id="environment"><a class="markdownIt-Anchor" href="#environment"></a> Environment</h3>
<ul>
<li>Development</li>
<li>Production</li>
<li>Testing</li>
</ul>
<h4 id="get-the-env-variable-in-javascript"><a class="markdownIt-Anchor" href="#get-the-env-variable-in-javascript"></a> Get the ENV variable in Javascript</h4>
<ul>
<li>First method</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">process.env.NODE_ENV; <span class="comment">// might be undefined.</span></span><br></pre></td></tr></table></figure>
<ul>
<li>Second method</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.get(<span class="string">"env"</span>) <span class="comment">// if undefined will return default value: development.</span></span><br></pre></td></tr></table></figure>
<ul>
<li>Use Morgan only in Development ENV</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// environment</span></span><br><span class="line"><span class="keyword">const</span> env = app.get(<span class="string">"env"</span>);</span><br><span class="line"><span class="keyword">if</span> (env === <span class="string">"development"</span>) &#123;</span><br><span class="line">    app.use(morgan(<span class="string">'tiny'</span>));</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"Morgan Loaded in Development Stage"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="set-the-environment-variable-in-shell"><a class="markdownIt-Anchor" href="#set-the-environment-variable-in-shell"></a> Set the Environment Variable in shell</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export NODE_ENV=production</span><br></pre></td></tr></table></figure>
<h4 id="use-config-management-package"><a class="markdownIt-Anchor" href="#use-config-management-package"></a> Use Config Management Package</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install config</span><br></pre></td></tr></table></figure>
<ul>
<li>write the config file<br>
<img src="https://s3-ap-southeast-2.amazonaws.com/geekeaskblogpics/posts/2019-03-19-11-51-04.png" alt></li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">// development.json -&gt; NODE_ENV=development  and so on</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"name"</span> : <span class="string">"My Express App - Development"</span>,</span><br><span class="line">    <span class="attr">"mail"</span>: &#123;</span><br><span class="line">        <span class="attr">"host"</span>: <span class="string">"dev-mail-server"</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<div class="note success">
            <p>通过export NODE_ENV可以根据<code>文件名</code>自动载入相应配置</p>
          </div>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> config = <span class="built_in">require</span>(<span class="string">"config"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// configuration</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"Application Name: "</span> + config.get(<span class="string">"name"</span>));</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"Mail Server Name: "</span> + config.get(<span class="string">"mail.host"</span>));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// environment</span></span><br><span class="line"><span class="keyword">const</span> env = app.get(<span class="string">"env"</span>);</span><br><span class="line"><span class="keyword">if</span> (env === <span class="string">"development"</span>) &#123;</span><br><span class="line">    app.use(morgan(<span class="string">'tiny'</span>));</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"Morgan Loaded in Development Stage"</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>But <code>don't</code> store password in default/prodcution/testing.json files.</p>
</li>
<li>
<p><strong>How to deal with secret/password?</strong> - In Environment Variable</p>
</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> app_privateKey = hellworld</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// config/custom-environment-variables.json</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"name"</span> : <span class="string">"My Express App - Development"</span>,</span><br><span class="line">    <span class="string">"mail"</span>: &#123;</span><br><span class="line">        <span class="string">"host"</span>: <span class="string">"dev-mail-server"</span>,</span><br><span class="line">        <span class="string">"password"</span>: <span class="string">"app-privateKey"</span> <span class="comment">// the env var name</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="string">`</span></span><br></pre></td></tr></table></figure>
<h3 id="debugging"><a class="markdownIt-Anchor" href="#debugging"></a> Debugging</h3>
<ul>
<li>不必每次都删除consol.log()</li>
<li>设置环境变量，控制debug启动或者关闭</li>
<li>设置显示信息的内容，程度</li>
</ul>
<div class="note default">
            <p>Install the Debug Package</p>
          </div>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i debug</span><br></pre></td></tr></table></figure>
<div class="note default">
            <p>Use debugger in code</p>
          </div>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> startupDebugger = <span class="built_in">require</span>(<span class="string">'debug'</span>)(<span class="string">"app:startup"</span>);</span><br><span class="line"><span class="keyword">const</span> dbDebugger = <span class="built_in">require</span>(<span class="string">'debug'</span>)(<span class="string">"app:db"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// console.log("Morgan Loaded in Development Stage")</span></span><br><span class="line">startupDebugger(<span class="string">"Morgan Loaded in Development Stage"</span>);</span><br><span class="line">dbDebugger(<span class="string">"Database debugger started."</span>)</span><br></pre></td></tr></table></figure>
<div class="note default">
            <p>Set the Env and Start Project</p>
          </div>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">set</span> the debugger to app: startup</span></span><br><span class="line">export DEBUG=app:startup  # enable startup debugging</span><br><span class="line">export DEBUG=app:db       # enable database debugging</span><br><span class="line">export DEBUG=             # disable debugging.</span><br><span class="line">export DEBUG=app:startup,app:db  # enable two debugging</span><br><span class="line">export DEBUG=APP:*        # enable all debugging</span><br><span class="line">nodemon app.js</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"> shortcut to <span class="built_in">set</span> debug and lanuch the application</span></span><br><span class="line">DEBUG=app:db nodemon app.js</span><br></pre></td></tr></table></figure>
<h3 id="template-engine"><a class="markdownIt-Anchor" href="#template-engine"></a> Template Engine</h3>
<ul>
<li>used to return html
<ul>
<li>Pug</li>
<li>Mustache</li>
<li>EJS</li>
</ul>
</li>
</ul>
<div class="note default">
            <p>Install pug</p>
          </div>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i pug</span><br></pre></td></tr></table></figure>
<div class="note default">
            <p>Set the views file.</p>
          </div>
<p><img src="https://s3-ap-southeast-2.amazonaws.com/geekeaskblogpics/posts/2019-03-19-13-07-48.png" alt></p>
<div class="note default">
            <p>Use views in code</p>
          </div>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">app.get(<span class="string">"/"</span>, (req,res) =&gt; &#123;</span><br><span class="line">    <span class="comment">// view file name + variables</span></span><br><span class="line">    res.render(<span class="string">"index"</span>, &#123;</span><br><span class="line">        title: <span class="string">"View Testing"</span>,</span><br><span class="line">        message: <span class="string">"Hello World"</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.set(<span class="string">'view engine'</span>, <span class="string">'pug'</span>);</span><br><span class="line">app.set(<span class="string">'views'</span>,<span class="string">'./views'</span>);</span><br></pre></td></tr></table></figure>
<h3 id="database-integration"><a class="markdownIt-Anchor" href="#database-integration"></a> <span class="exturl" data-url="aHR0cHM6Ly9leHByZXNzanMuY29tL2VuL2d1aWRlL2RhdGFiYXNlLWludGVncmF0aW9uLmh0bWw=" title="https://expressjs.com/en/guide/database-integration.html">Database Integration<i class="fa fa-external-link"></i></span></h3>
<h2 id="code-one-genre-refractured"><a class="markdownIt-Anchor" href="#code-one-genre-refractured"></a> Code One Genre: Refractured</h2>
<img style="width: 400px; margin: auto" src="https://s3-ap-southeast-2.amazonaws.com/geekeaskblogpics/posts/WechatIMG2.jpeg">
<div class="note ">
            <table><thead><tr><th style="text-align:left">Folder</th><th style="text-align:left">Description</th></tr></thead><tbody><tr><td style="text-align:left">config</td><td style="text-align:left">store configuration</td></tr><tr><td style="text-align:left">middleware</td><td style="text-align:left">store all middlewares</td></tr><tr><td style="text-align:left">public</td><td style="text-align:left">store static files</td></tr><tr><td style="text-align:left">routers</td><td style="text-align:left">store all routers</td></tr><tr><td style="text-align:left">views</td><td style="text-align:left">store template pug files</td></tr></tbody></table>
          </div>
<hr>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// routers/home.js</span></span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">"express"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> router = express.Router();</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">"/"</span>, (req,res) =&gt; &#123;</span><br><span class="line">    res.render(<span class="string">"index"</span>, &#123;</span><br><span class="line">        title: <span class="string">"View Testing"</span>,</span><br><span class="line">        message: <span class="string">"Hello World"</span></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = router;</span><br></pre></td></tr></table></figure>
<hr>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// routers/genres.js</span></span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">"express"</span>);</span><br><span class="line"><span class="keyword">const</span> Joi = <span class="built_in">require</span>(<span class="string">"joi"</span>);</span><br><span class="line"><span class="keyword">const</span> router = express.Router();</span><br><span class="line"></span><br><span class="line"><span class="comment">// data part</span></span><br><span class="line"><span class="keyword">const</span> genres = [</span><br><span class="line">    &#123;<span class="attr">id</span>: <span class="number">1</span>, <span class="attr">name</span>: <span class="string">"Comedy"</span>&#125;,</span><br><span class="line">    &#123;<span class="attr">id</span>: <span class="number">2</span>, <span class="attr">name</span>: <span class="string">"Fantasy"</span>&#125;,</span><br><span class="line">    &#123;<span class="attr">id</span>: <span class="number">3</span>, <span class="attr">name</span>: <span class="string">"Horror"</span>&#125;,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment">// middleware function</span></span><br><span class="line">router.use(<span class="function">(<span class="params">req,res,next</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// sth you want to do.</span></span><br><span class="line">    next();</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// list all genres</span></span><br><span class="line">router.get(<span class="string">"/"</span>, (req,res) =&gt; &#123;</span><br><span class="line">    res.send(genres);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// GET request</span></span><br><span class="line">router.get(<span class="string">"/:id"</span>, (req,res) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> genre = genres.find(<span class="function"><span class="params">c</span> =&gt;</span> c.id === <span class="built_in">parseInt</span>(req.params.id));</span><br><span class="line">    <span class="keyword">if</span>(!genre)&#123;</span><br><span class="line">        res.status(<span class="number">404</span>).send(<span class="string">"genre doesn't exist."</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    res.send(genre);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// POST request</span></span><br><span class="line">router.post(<span class="string">'/'</span>, (req, res) =&gt; &#123;</span><br><span class="line">    <span class="comment">// validation</span></span><br><span class="line">    <span class="keyword">const</span> schema = &#123;</span><br><span class="line">        name: Joi.string().required()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> result = Joi.validate(req.body,schema);</span><br><span class="line">    <span class="keyword">if</span> (result.error)&#123;</span><br><span class="line">        res.status(<span class="number">400</span>).send(result.error.details[<span class="number">0</span>].message);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// update the data</span></span><br><span class="line">    <span class="keyword">const</span> genre = &#123;</span><br><span class="line">        id: genres.length + <span class="number">1</span>,</span><br><span class="line">        name: req.body.name</span><br><span class="line">    &#125;;</span><br><span class="line">    genres.push(genre);</span><br><span class="line">    res.send(genre);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// PUT request</span></span><br><span class="line">router.put(<span class="string">"/:id"</span>, (req,res) =&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// find the genre</span></span><br><span class="line">    <span class="keyword">const</span> genre = genres.find(<span class="function"><span class="params">c</span> =&gt;</span> c.id === <span class="built_in">parseInt</span>(req.params.id));</span><br><span class="line">    <span class="keyword">if</span> (!genre)&#123;</span><br><span class="line">        res.status(<span class="number">404</span>).send(<span class="string">"Genre not found."</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// validation</span></span><br><span class="line">    <span class="keyword">const</span> schema = &#123;</span><br><span class="line">        name: Joi.string().required()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> result = Joi.validate(req.body, schema);</span><br><span class="line">    <span class="keyword">if</span> (result.error)&#123;</span><br><span class="line">        res.status(<span class="number">400</span>).send(result.error.details[<span class="number">0</span>].message);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// modify the data</span></span><br><span class="line">    genre.name = req.body.name;</span><br><span class="line">    res.send(genre);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// DELETE request</span></span><br><span class="line">router.delete(<span class="string">"/:id"</span>, (req,res)=&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> genre = genres.find(<span class="function"><span class="params">c</span> =&gt;</span> c.id === <span class="built_in">parseInt</span>(req.params.id));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!genre)&#123;</span><br><span class="line">        res.status(<span class="number">404</span>).send(<span class="string">"genre not found."</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    genres.splice(genres.indexOf(genre), <span class="number">1</span>);</span><br><span class="line">    res.send(genre);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = router;</span><br></pre></td></tr></table></figure>
<hr>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app.js</span></span><br><span class="line"><span class="keyword">const</span> startupDebugger = <span class="built_in">require</span>(<span class="string">'debug'</span>)(<span class="string">"app:startup"</span>);</span><br><span class="line"><span class="keyword">const</span> dbDebugger = <span class="built_in">require</span>(<span class="string">'debug'</span>)(<span class="string">"app:db"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> config = <span class="built_in">require</span>(<span class="string">"config"</span>);</span><br><span class="line"><span class="keyword">const</span> morgan = <span class="built_in">require</span>(<span class="string">"morgan"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">"express"</span>);</span><br><span class="line"><span class="keyword">const</span> home = <span class="built_in">require</span>(<span class="string">"./routes/home"</span>);</span><br><span class="line"><span class="keyword">const</span> genres = <span class="built_in">require</span>(<span class="string">"./routes/genres"</span>)</span><br><span class="line"><span class="keyword">const</span> app = express();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> port = process.env.PORT || <span class="number">3000</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// configuration</span></span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"Application Name: "</span> + config.get(<span class="string">"name"</span>));</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">"Mail Server Name: "</span> + config.get(<span class="string">"mail.host"</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// environment</span></span><br><span class="line"><span class="keyword">const</span> env = app.get(<span class="string">"env"</span>);</span><br><span class="line"><span class="keyword">if</span> (env === <span class="string">"development"</span>) &#123;</span><br><span class="line">    app.use(morgan(<span class="string">'tiny'</span>));</span><br><span class="line">    startupDebugger(<span class="string">"Morgan Loaded in Development Stage"</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// database work ...</span></span><br><span class="line">dbDebugger(<span class="string">"database debugger"</span>)</span><br><span class="line"></span><br><span class="line">app.set(<span class="string">'view engine'</span>, <span class="string">'pug'</span>);</span><br><span class="line">app.set(<span class="string">'views'</span>,<span class="string">'./views'</span>);</span><br><span class="line"></span><br><span class="line">app.use(express.static(<span class="string">"public"</span>));</span><br><span class="line">app.use(express.urlencoded(&#123;<span class="attr">extended</span>: <span class="literal">true</span>&#125;))</span><br><span class="line">app.use(express.json());</span><br><span class="line"></span><br><span class="line">app.use(<span class="string">"/"</span>,home);</span><br><span class="line">app.use(<span class="string">"/api/genres"</span>,genres);</span><br><span class="line"></span><br><span class="line">app.listen(port);</span><br></pre></td></tr></table></figure>
<h2 id="mongodb"><a class="markdownIt-Anchor" href="#mongodb"></a> MongoDB</h2>
<h3 id="configuration"><a class="markdownIt-Anchor" href="#configuration"></a> Configuration</h3>
<h4 id="install-mongodb"><a class="markdownIt-Anchor" href="#install-mongodb"></a> Install MongoDB</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install mongodb</span><br></pre></td></tr></table></figure>
<h4 id="create-data-directory"><a class="markdownIt-Anchor" href="#create-data-directory"></a> Create Data Directory</h4>
<div class="note success">
            <p>Modify mongod.conf to set the database path.</p>
          </div>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo mkdir -p /data/db</span><br><span class="line">sudo chown -R `id -un` /data/db</span><br></pre></td></tr></table></figure>
<h4 id="run-mongodb-in-shell"><a class="markdownIt-Anchor" href="#run-mongodb-in-shell"></a> Run MongoDB in Shell</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mongod # or</span><br><span class="line">mongod --config /usr/local/etc/mongod.conf</span><br></pre></td></tr></table></figure>
<ul>
<li>the port is 27017</li>
</ul>
<h4 id="run-mongodb-by-brew"><a class="markdownIt-Anchor" href="#run-mongodb-by-brew"></a> Run MongoDB by brew</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">brew services start mongodb</span><br><span class="line">brew services stop mongodb</span><br></pre></td></tr></table></figure>
<h3 id="mongodb-gui-client"><a class="markdownIt-Anchor" href="#mongodb-gui-client"></a> MongoDB GUI Client</h3>
<ul>
<li>Robot 3T [Simple][<strong>Free</strong>]</li>
<li>dbKoda [import &amp; output &amp; charts]</li>
<li>Studo 3T [Support SQL][<strong>Expensive</strong>]</li>
</ul>
<h3 id="node-to-mongodb"><a class="markdownIt-Anchor" href="#node-to-mongodb"></a> Node to MongoDB</h3>
<h4 id="connect"><a class="markdownIt-Anchor" href="#connect"></a> Connect</h4>
<blockquote>
<p>simple api: mongoose.</p>
</blockquote>
<div class="note default">
            <p>Install Mongoose</p>
          </div>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i mongoose</span><br></pre></td></tr></table></figure>
<div class="note default">
            <p>Connect to Mongodb</p>
          </div>
<div class="note success">
            <p>mongoose will create database for you automatically once you create a new record in it.</p>
          </div>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// host: localhost</span></span><br><span class="line"><span class="comment">// 27017: port</span></span><br><span class="line"><span class="comment">// database: playground</span></span><br><span class="line"><span class="comment">// return: a promise object.</span></span><br><span class="line">mongoose</span><br><span class="line">	.connect(<span class="string">'mongodb://localhost:27017/playground'</span>, &#123;<span class="attr">useNewUrlParser</span>: <span class="literal">true</span>&#125;) <span class="comment">// MongoDB will create the playground automatically</span></span><br><span class="line">	.then(<span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">'Connecting to the MongoDB...'</span>))</span><br><span class="line">    .catch(<span class="function">(<span class="params">err</span>) =&gt;</span> <span class="built_in">console</span>.log(err));</span><br></pre></td></tr></table></figure>
<h4 id="define-collections-and-validations"><a class="markdownIt-Anchor" href="#define-collections-and-validations"></a> Define Collections and Validations</h4>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Define the database</span></span><br><span class="line"><span class="keyword">const</span> courseSchema = <span class="keyword">new</span> mongoose.Schema(&#123;</span><br><span class="line">	<span class="comment">// 使得unique生效，必须删除数据库，重启服务，才可以</span></span><br><span class="line">	name: &#123; <span class="attr">type</span>: <span class="built_in">String</span>, <span class="attr">required</span>: <span class="literal">true</span>, <span class="attr">unique</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">	author: <span class="built_in">String</span>,</span><br><span class="line">	tags: [ <span class="built_in">String</span> ], <span class="comment">// this means a list of string</span></span><br><span class="line">	date: &#123; <span class="attr">type</span>: <span class="built_in">Date</span>, <span class="attr">default</span>: <span class="built_in">Date</span>.now &#125;,</span><br><span class="line">	isPublished: <span class="built_in">Boolean</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// class Course &lt;=&gt; collection 'Course'</span></span><br><span class="line"><span class="keyword">const</span> Course = mongoose.model(<span class="string">'Course'</span>, courseSchema);</span><br></pre></td></tr></table></figure>
<h3 id="crud"><a class="markdownIt-Anchor" href="#crud"></a> CRUD</h3>
<h4 id="create-documents"><a class="markdownIt-Anchor" href="#create-documents"></a> Create Documents</h4>
<br>
<div class="note ">
            <ul><li>Mongo Concept<ul><li>collection: similar to one <strong>table</strong> in the relational database</li><li>document: similar to one <strong>row</strong> in the relational database</li></ul></li><li>Mongoose Concept<ul><li>schema: define the shape of <strong>documents</strong></li><li>model: correspont to class in javascript, referring to collection, defined and created using the schema.</li></ul></li></ul>
          </div>
<ul>
<li>Mongoose Data Types
<ul>
<li>String Number(包含小数) Date Boolean Array Map</li>
<li>Mixed ObjectId  Decimal128 Buffer</li>
</ul>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CREATE operation</span></span><br><span class="line"><span class="keyword">const</span> data = &#123;</span><br><span class="line">	name: <span class="string">'Database Management'</span>,</span><br><span class="line">	author: <span class="string">'James Tan'</span>,</span><br><span class="line">	tags: [ <span class="string">'node'</span>, <span class="string">'backend'</span> ],</span><br><span class="line">	<span class="comment">// use default value for date</span></span><br><span class="line">	isPublished: <span class="literal">true</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">createSingleCourse</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">	<span class="comment">// create an instance</span></span><br><span class="line">	<span class="keyword">const</span> course = <span class="keyword">new</span> Course(data);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// return a promise</span></span><br><span class="line">	<span class="keyword">const</span> result = <span class="keyword">await</span> course.save();</span><br><span class="line">	<span class="built_in">console</span>.log(result);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">createSingleCourse(data);</span><br></pre></td></tr></table></figure>
<h4 id="query-documents"><a class="markdownIt-Anchor" href="#query-documents"></a> Query Documents</h4>
<br>
<div class="note primary">
            <ul><li>Compare Operator<ul><li>$eq: equal</li><li>$ne: not equal</li><li>$gt: greater than</li><li>$gte: greater than or equal to</li><li>$lt: less than</li><li>$lte: less than or equal to</li><li>$in: in</li><li>$nin: not in</li></ul></li></ul><hr><ul><li>Logical Opeartor<ul><li>or: or</li><li>and :and</li></ul></li></ul>
          </div>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// READ Operation - Get All Courses</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">getAllCourses</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="keyword">const</span> courses = <span class="keyword">await</span> Course.find();</span><br><span class="line">	<span class="built_in">console</span>.log(courses);</span><br><span class="line">&#125;</span><br><span class="line">getAllCourses();</span><br><span class="line"></span><br><span class="line"><span class="comment">// READ Operation - query using filter</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">getCourse</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="keyword">const</span> courses = <span class="keyword">await</span> Course.find(&#123; <span class="attr">name</span>: <span class="string">'Database Management'</span> &#125;)</span><br><span class="line">		.limit(<span class="number">10</span>)</span><br><span class="line">		.sort(&#123; <span class="attr">name</span>: <span class="number">1</span> &#125;) <span class="comment">// 1 for ascending order</span></span><br><span class="line">		.select(&#123; <span class="attr">name</span>: <span class="number">1</span>, <span class="attr">tags</span>: <span class="number">1</span> &#125;);</span><br><span class="line">	<span class="built_in">console</span>.log(courses);</span><br><span class="line">&#125;</span><br><span class="line">getCourse();</span><br><span class="line"></span><br><span class="line"><span class="comment">// READ Operation - query compare</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">getCourseCompare</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> courses = <span class="keyword">await</span> Course</span><br><span class="line">        <span class="comment">// .find(&#123; price: &#123;$gt: 11&#125;&#125;)</span></span><br><span class="line">        .find(&#123; <span class="attr">price</span>: &#123;<span class="attr">$in</span>: [<span class="number">10.2</span>,<span class="number">30</span>]&#125;&#125;)</span><br><span class="line">		.limit(<span class="number">10</span>)</span><br><span class="line">		.sort(&#123; <span class="attr">name</span>: <span class="number">1</span> &#125;) <span class="comment">// 1 for ascending order</span></span><br><span class="line">		.select(&#123; <span class="attr">name</span>: <span class="number">1</span>, <span class="attr">tags</span>: <span class="number">1</span> &#125;);</span><br><span class="line">	<span class="built_in">console</span>.log(courses);</span><br><span class="line">&#125;</span><br><span class="line">getCourseCompare();</span><br><span class="line"></span><br><span class="line"><span class="comment">// READ Operation - query compare OR AND</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">getCourseCompareOr</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> courses = <span class="keyword">await</span> Course</span><br><span class="line">        .find() <span class="comment">// find() is necessary</span></span><br><span class="line">        .or(&#123;<span class="attr">price</span>: &#123;<span class="attr">$gt</span>: <span class="number">15</span>&#125;&#125;, &#123;<span class="attr">name</span>: <span class="string">"Database Management"</span>&#125;)</span><br><span class="line">		.limit(<span class="number">10</span>)</span><br><span class="line">		.sort(&#123; <span class="attr">name</span>: <span class="number">1</span> &#125;) <span class="comment">// 1 for ascending order</span></span><br><span class="line">		.select(&#123; <span class="attr">name</span>: <span class="number">1</span>, <span class="attr">tags</span>: <span class="number">1</span>, <span class="attr">price</span>:<span class="number">1</span> &#125;);</span><br><span class="line">	<span class="built_in">console</span>.log(courses);</span><br><span class="line">&#125;</span><br><span class="line">getCourseCompareOr();</span><br><span class="line"></span><br><span class="line"><span class="comment">// READ Operation - query compare Regular Expression</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">getCourseCompareRegular</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> courses = <span class="keyword">await</span> Course</span><br><span class="line">        .find(&#123;<span class="attr">name</span>: <span class="regexp">/^data/i</span> &#125;) <span class="comment">// start with data or Data</span></span><br><span class="line">		.limit(<span class="number">10</span>)</span><br><span class="line">		.sort(&#123; <span class="attr">name</span>: <span class="number">1</span> &#125;) <span class="comment">// 1 for ascending order</span></span><br><span class="line">		.select(&#123; <span class="attr">name</span>: <span class="number">1</span>, <span class="attr">tags</span>: <span class="number">1</span>, <span class="attr">price</span>:<span class="number">1</span> &#125;);</span><br><span class="line">	<span class="built_in">console</span>.log(courses);</span><br><span class="line">&#125;</span><br><span class="line">getCourseCompareRegular();</span><br><span class="line"></span><br><span class="line"><span class="comment">// READ Operation - query count</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">getCourseCompareCount</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> courses = <span class="keyword">await</span> Course</span><br><span class="line">        .find(&#123;<span class="attr">name</span>: <span class="regexp">/^data/i</span> &#125;) <span class="comment">// start with data or Data</span></span><br><span class="line">		.limit(<span class="number">10</span>)</span><br><span class="line">		.sort(&#123; <span class="attr">name</span>: <span class="number">1</span> &#125;) <span class="comment">// 1 for ascending order</span></span><br><span class="line">        .select(&#123; <span class="attr">name</span>: <span class="number">1</span>, <span class="attr">tags</span>: <span class="number">1</span>, <span class="attr">price</span>:<span class="number">1</span> &#125;)</span><br><span class="line">        .countDocuments();</span><br><span class="line">	<span class="built_in">console</span>.log(courses);</span><br><span class="line">&#125;</span><br><span class="line">getCourseCompareCount();</span><br><span class="line"></span><br><span class="line"><span class="comment">// READ Operation - query pagination</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">getCourseComparePagination</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// /api/courses?pageNumber=2&amp;pageSize=10</span></span><br><span class="line">    <span class="keyword">const</span> pageNumber = <span class="number">1</span>; <span class="comment">// 第几页</span></span><br><span class="line">    <span class="keyword">const</span> pageSize = <span class="number">10</span>; <span class="comment">// 一页几个documents</span></span><br><span class="line">    <span class="keyword">const</span> courses = <span class="keyword">await</span> Course</span><br><span class="line">        .find() <span class="comment">// start with data or Data</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// these two lines are the pagination</span></span><br><span class="line">        .skip((pageNumber - <span class="number">1</span>) * pageSize)</span><br><span class="line">        .limit(pageSize)</span><br><span class="line">        </span><br><span class="line">		.sort(&#123; <span class="attr">name</span>: <span class="number">1</span> &#125;) <span class="comment">// 1 for ascending order</span></span><br><span class="line">        .select(&#123; <span class="attr">name</span>: <span class="number">1</span>, <span class="attr">tags</span>: <span class="number">1</span>, <span class="attr">price</span>:<span class="number">1</span> &#125;)</span><br><span class="line">	<span class="built_in">console</span>.log(courses);</span><br><span class="line">&#125;</span><br><span class="line">getCourseComparePagination();</span><br></pre></td></tr></table></figure>
<h4 id="update-documents"><a class="markdownIt-Anchor" href="#update-documents"></a> Update Documents</h4>
<br>
<div class="note default">
            <p>When you need check the existence of document at first</p>
          </div>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UPDATE Operation - find + save</span></span><br><span class="line"><span class="comment">// when you need to check if the record exists or not</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">findThenUpdateCourse</span>(<span class="params">id</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> course = <span class="keyword">await</span> Course.findById(id);</span><br><span class="line">    <span class="keyword">if</span>(!course) <span class="keyword">return</span>;</span><br><span class="line">    course.isPublished = <span class="literal">true</span>;</span><br><span class="line">    course.name = <span class="string">"Java"</span>;</span><br><span class="line">    course.tags = [<span class="string">"backend"</span>,<span class="string">"OOP"</span>];</span><br><span class="line">    course.price = <span class="number">15</span>;</span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> course.save();</span><br><span class="line">    <span class="built_in">console</span>.log(result);</span><br><span class="line">&#125;</span><br><span class="line">findThenUpdateCourse(<span class="string">"5c919cb9310fd622b1db90bd"</span>);</span><br></pre></td></tr></table></figure>
<div class="note default">
            <p>When you confirm the existence of document</p>
          </div>
<div class="note primary">
            <p><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm1vbmdvZGIuY29tL21hbnVhbC9yZWZlcmVuY2Uvb3BlcmF0b3IvdXBkYXRlLw==" title="https://docs.mongodb.com/manual/reference/operator/update/">Update Operator<i class="fa fa-external-link"></i></span></p>
          </div>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UPDATE Operation - direct update</span></span><br><span class="line"><span class="comment">// when you confirm the course already exists</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">updateCourse</span>(<span class="params">id</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> Course.update(</span><br><span class="line">        &#123; <span class="attr">_id</span>:id, <span class="attr">isPublished</span>: <span class="literal">false</span>&#125;,</span><br><span class="line">        &#123; <span class="attr">$set</span>: &#123;</span><br><span class="line">            author: <span class="string">"Mosh"</span>,</span><br><span class="line">            isPublished: <span class="literal">true</span></span><br><span class="line">        &#125;&#125;);</span><br><span class="line">    <span class="built_in">console</span>.log(result);</span><br><span class="line">&#125;</span><br><span class="line">updateCourse(<span class="string">"5c919cb9310fd622b1db90bd"</span>);</span><br></pre></td></tr></table></figure>
<div class="note default">
            <p>When you want to get the old documents as results.</p>
          </div>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UPDATE Operation - update with old as result</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">updateCourseWithOldRecords</span>(<span class="params">id</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> Course.findByIdAndUpdate(id,</span><br><span class="line">        &#123; <span class="attr">$set</span>: &#123;</span><br><span class="line">            author: <span class="string">"Mosh"</span>,</span><br><span class="line">            isPublished: <span class="literal">true</span></span><br><span class="line">        &#125;&#125;);</span><br><span class="line">    <span class="built_in">console</span>.log(result);</span><br><span class="line">&#125;</span><br><span class="line">updateCourseWithOldRecords(<span class="string">"5c919cb9310fd622b1db90bd"</span>);</span><br></pre></td></tr></table></figure>
<div class="note default">
            <p>When you want to get the updated documents as results.</p>
          </div>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// UPDATE Operation - update with new as result</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">updateCourseWithUpdatedRecord</span>(<span class="params">id</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> Course.findByIdAndUpdate(id,</span><br><span class="line">        &#123; <span class="attr">$set</span>: &#123;</span><br><span class="line">            author: <span class="string">"Mosh"</span>,</span><br><span class="line">            isPublished: <span class="literal">true</span></span><br><span class="line">        &#125;&#125;,&#123;<span class="attr">new</span>:<span class="literal">true</span>&#125;);</span><br><span class="line">    <span class="built_in">console</span>.log(result);</span><br><span class="line">&#125;</span><br><span class="line">updateCourseWithUpdatedRecord(<span class="string">"5c919cb9310fd622b1db90bd"</span>);</span><br></pre></td></tr></table></figure>
<h4 id="remove-documents"><a class="markdownIt-Anchor" href="#remove-documents"></a> Remove Documents</h4>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">removeCourse</span>(<span class="params">id</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// delete the first one found</span></span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> Course.deleteOne(&#123;<span class="attr">_id</span>: id&#125;)</span><br><span class="line">    <span class="comment">// delete all</span></span><br><span class="line">    <span class="comment">// const result = await Course.deleteMany(&#123;isPublished:true&#125;)</span></span><br><span class="line">    <span class="comment">// const course = await Course.findByIdAndRemove(id);</span></span><br><span class="line">    <span class="built_in">console</span>.log(result);</span><br><span class="line">&#125;</span><br><span class="line">removeCourse(<span class="string">"5c919cb9310fd622b1db90bd"</span>);</span><br></pre></td></tr></table></figure>
<h3 id="code-two-course-crud"><a class="markdownIt-Anchor" href="#code-two-course-crud"></a> Code Two Course: CRUD</h3>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>);</span><br><span class="line">mongoose.set(<span class="string">'useCreateIndex'</span>,<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// host: localhost</span></span><br><span class="line"><span class="comment">// 27017: port</span></span><br><span class="line"><span class="comment">// database: playground</span></span><br><span class="line"><span class="comment">// return: a promise object.</span></span><br><span class="line">mongoose</span><br><span class="line">	.connect(<span class="string">'mongodb://localhost:27017/playground'</span>, &#123; <span class="attr">useNewUrlParser</span>: <span class="literal">true</span> &#125;)</span><br><span class="line">	.then(<span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="string">'Connecting to the MongoDB...'</span>))</span><br><span class="line">	.catch(<span class="function">(<span class="params">err</span>) =&gt;</span> <span class="built_in">console</span>.log(err));</span><br><span class="line"></span><br><span class="line"><span class="comment">// Define the database</span></span><br><span class="line"><span class="keyword">const</span> courseSchema = <span class="keyword">new</span> mongoose.Schema(&#123;</span><br><span class="line">	<span class="comment">// 使得unique生效，必须删除数据库，重启服务，才可以</span></span><br><span class="line">	name: &#123; <span class="attr">type</span>: <span class="built_in">String</span>, <span class="attr">required</span>: <span class="literal">true</span>, <span class="attr">unique</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">	author: <span class="built_in">String</span>,</span><br><span class="line">	tags: [ <span class="built_in">String</span> ], <span class="comment">// this means a list of string</span></span><br><span class="line">	date: &#123; <span class="attr">type</span>: <span class="built_in">Date</span>, <span class="attr">default</span>: <span class="built_in">Date</span>.now &#125;,</span><br><span class="line">    isPublished: <span class="built_in">Boolean</span>,</span><br><span class="line">    price: &#123;<span class="attr">type</span>: <span class="built_in">Number</span>, <span class="attr">required</span>: <span class="literal">true</span>&#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// class Course &lt;=&gt; collection 'Course'</span></span><br><span class="line"><span class="keyword">const</span> Course = mongoose.model(<span class="string">'Course'</span>, courseSchema);</span><br><span class="line"></span><br><span class="line"><span class="comment">// CRUD is based on model.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. CREATE operation</span></span><br><span class="line"><span class="keyword">const</span> data1 = &#123;</span><br><span class="line">	name: <span class="string">'Database Management'</span>,</span><br><span class="line">	author: <span class="string">'James Tan'</span>,</span><br><span class="line">	tags: [ <span class="string">'database'</span>, <span class="string">'backend'</span> ],</span><br><span class="line">	<span class="comment">// use default value for date</span></span><br><span class="line">    isPublished: <span class="literal">true</span>,</span><br><span class="line">    price: <span class="number">10.2</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> data2 = &#123;</span><br><span class="line">    name: <span class="string">'Node Js Course'</span>,</span><br><span class="line">	author: <span class="string">'James Tan'</span>,</span><br><span class="line">	tags: [ <span class="string">'node'</span>, <span class="string">'backend'</span> ],</span><br><span class="line">	<span class="comment">// use default value for date</span></span><br><span class="line">    isPublished: <span class="literal">true</span>,</span><br><span class="line">    price: <span class="number">30</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">createSingleCourse</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">	<span class="comment">// create an instance</span></span><br><span class="line">	<span class="keyword">const</span> course = <span class="keyword">new</span> Course(data);</span><br><span class="line">	<span class="comment">// return a promise</span></span><br><span class="line">	<span class="keyword">const</span> result = <span class="keyword">await</span> course.save();</span><br><span class="line">	<span class="built_in">console</span>.log(result);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// createSingleCourse(data1);</span></span><br><span class="line"><span class="comment">// createSingleCourse(data2);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 2.1 READ Operation - Get All Courses</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">getAllCourses</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="keyword">const</span> courses = <span class="keyword">await</span> Course.find();</span><br><span class="line">	<span class="built_in">console</span>.log(courses);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// getAllCourses();</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 2.2 READ Operation - query using filter</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">getCourse</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="keyword">const</span> courses = <span class="keyword">await</span> Course.find(&#123; <span class="attr">name</span>: <span class="string">'Database Management'</span> &#125;)</span><br><span class="line">		.limit(<span class="number">10</span>)</span><br><span class="line">		.sort(&#123; <span class="attr">name</span>: <span class="number">1</span> &#125;) <span class="comment">// 1 for ascending order</span></span><br><span class="line">		.select(&#123; <span class="attr">name</span>: <span class="number">1</span>, <span class="attr">tags</span>: <span class="number">1</span> &#125;);</span><br><span class="line">	<span class="built_in">console</span>.log(courses);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// getCourse();</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 2.3 READ Operation - query compare</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">getCourseCompare</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> courses = <span class="keyword">await</span> Course</span><br><span class="line">        <span class="comment">// .find(&#123; price: &#123;$gt: 11&#125;&#125;)</span></span><br><span class="line">        .find(&#123; <span class="attr">price</span>: &#123;<span class="attr">$in</span>: [<span class="number">10.2</span>,<span class="number">30</span>]&#125;&#125;)</span><br><span class="line">		.limit(<span class="number">10</span>)</span><br><span class="line">		.sort(&#123; <span class="attr">name</span>: <span class="number">1</span> &#125;) <span class="comment">// 1 for ascending order</span></span><br><span class="line">		.select(&#123; <span class="attr">name</span>: <span class="number">1</span>, <span class="attr">tags</span>: <span class="number">1</span> &#125;);</span><br><span class="line">	<span class="built_in">console</span>.log(courses);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// getCourseCompare();</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 2.4 READ Operation - query compare OR AND</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">getCourseCompareOr</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> courses = <span class="keyword">await</span> Course</span><br><span class="line">        .find() <span class="comment">// find() is necessary</span></span><br><span class="line">        .or(&#123;<span class="attr">price</span>: &#123;<span class="attr">$gt</span>: <span class="number">15</span>&#125;&#125;, &#123;<span class="attr">name</span>: <span class="string">"Database Management"</span>&#125;)</span><br><span class="line">		.limit(<span class="number">10</span>)</span><br><span class="line">		.sort(&#123; <span class="attr">name</span>: <span class="number">1</span> &#125;) <span class="comment">// 1 for ascending order</span></span><br><span class="line">		.select(&#123; <span class="attr">name</span>: <span class="number">1</span>, <span class="attr">tags</span>: <span class="number">1</span>, <span class="attr">price</span>:<span class="number">1</span> &#125;);</span><br><span class="line">	<span class="built_in">console</span>.log(courses);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// getCourseCompareOr();</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 2.5 READ Operation - query compare Regular Expression</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">getCourseCompareRegular</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> courses = <span class="keyword">await</span> Course</span><br><span class="line">        .find(&#123;<span class="attr">name</span>: <span class="regexp">/^data/i</span> &#125;) <span class="comment">// start with data or Data</span></span><br><span class="line">		.limit(<span class="number">10</span>)</span><br><span class="line">		.sort(&#123; <span class="attr">name</span>: <span class="number">1</span> &#125;) <span class="comment">// 1 for ascending order</span></span><br><span class="line">		.select(&#123; <span class="attr">name</span>: <span class="number">1</span>, <span class="attr">tags</span>: <span class="number">1</span>, <span class="attr">price</span>:<span class="number">1</span> &#125;);</span><br><span class="line">	<span class="built_in">console</span>.log(courses);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// getCourseCompareRegular();</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 2.6 READ Operation - query count</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">getCourseCompareCount</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> courses = <span class="keyword">await</span> Course</span><br><span class="line">        .find(&#123;<span class="attr">name</span>: <span class="regexp">/^data/i</span> &#125;) <span class="comment">// start with data or Data</span></span><br><span class="line">		.limit(<span class="number">10</span>)</span><br><span class="line">		.sort(&#123; <span class="attr">name</span>: <span class="number">1</span> &#125;) <span class="comment">// 1 for ascending order</span></span><br><span class="line">        .select(&#123; <span class="attr">name</span>: <span class="number">1</span>, <span class="attr">tags</span>: <span class="number">1</span>, <span class="attr">price</span>:<span class="number">1</span> &#125;)</span><br><span class="line">        .countDocuments();</span><br><span class="line">	<span class="built_in">console</span>.log(courses);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// getCourseCompareCount();</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 2.6 READ Operation - query pagination</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">getCourseComparePagination</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// /api/courses?pageNumber=2&amp;pageSize=10</span></span><br><span class="line">    <span class="keyword">const</span> pageNumber = <span class="number">1</span>; <span class="comment">// 第几页</span></span><br><span class="line">    <span class="keyword">const</span> pageSize = <span class="number">10</span>; <span class="comment">// 一页几个documents</span></span><br><span class="line">    <span class="keyword">const</span> courses = <span class="keyword">await</span> Course</span><br><span class="line">        .find() <span class="comment">// start with data or Data</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// these two lines are the pagination</span></span><br><span class="line">        .skip((pageNumber - <span class="number">1</span>) * pageSize)</span><br><span class="line">        .limit(pageSize)</span><br><span class="line">        </span><br><span class="line">		.sort(&#123; <span class="attr">name</span>: <span class="number">1</span> &#125;) <span class="comment">// 1 for ascending order</span></span><br><span class="line">        .select(&#123; <span class="attr">name</span>: <span class="number">1</span>, <span class="attr">tags</span>: <span class="number">1</span>, <span class="attr">price</span>:<span class="number">1</span> &#125;)</span><br><span class="line">	<span class="built_in">console</span>.log(courses);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// getCourseComparePagination();</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.1 UPDATE Operation - find + save</span></span><br><span class="line"><span class="comment">// when you need to check if the record exists or not</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">findThenUpdateCourse</span>(<span class="params">id</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> course = <span class="keyword">await</span> Course.findById(id);</span><br><span class="line">    <span class="keyword">if</span>(!course) <span class="keyword">return</span>;</span><br><span class="line">    course.isPublished = <span class="literal">true</span>;</span><br><span class="line">    course.name = <span class="string">"Java"</span>;</span><br><span class="line">    course.tags = [<span class="string">"backend"</span>,<span class="string">"OOP"</span>];</span><br><span class="line">    course.price = <span class="number">15</span>;</span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> course.save();</span><br><span class="line">    <span class="built_in">console</span>.log(result);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// findThenUpdateCourse("5c919cb9310fd622b1db90bd");</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.2 UPDATE Operation - direct update</span></span><br><span class="line"><span class="comment">// when you confirm the course already exists</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">updateCourse</span>(<span class="params">id</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> Course.update(</span><br><span class="line">        &#123; <span class="attr">_id</span>:id, <span class="attr">isPublished</span>: <span class="literal">false</span>&#125;,</span><br><span class="line">        &#123; <span class="attr">$set</span>: &#123;</span><br><span class="line">            author: <span class="string">"Mosh"</span>,</span><br><span class="line">            isPublished: <span class="literal">true</span></span><br><span class="line">        &#125;&#125;);</span><br><span class="line">    <span class="built_in">console</span>.log(result);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// updateCourse("5c919cb9310fd622b1db90bd");</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.3 UPDATE Operation - update with old as result</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">updateCourseWithOldRecords</span>(<span class="params">id</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> Course.findByIdAndUpdate(id,</span><br><span class="line">        &#123; <span class="attr">$set</span>: &#123;</span><br><span class="line">            author: <span class="string">"Mosh"</span>,</span><br><span class="line">            isPublished: <span class="literal">true</span></span><br><span class="line">        &#125;&#125;);</span><br><span class="line">    <span class="built_in">console</span>.log(result);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// updateCourseWithOldRecords("5c919cb9310fd622b1db90bd");</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 3.4 UPDATE Operation - update with new as result</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">updateCourseWithUpdatedRecord</span>(<span class="params">id</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> Course.findByIdAndUpdate(id,</span><br><span class="line">        &#123; <span class="attr">$set</span>: &#123;</span><br><span class="line">            author: <span class="string">"Mosh"</span>,</span><br><span class="line">            isPublished: <span class="literal">true</span></span><br><span class="line">        &#125;&#125;,&#123;<span class="attr">new</span>:<span class="literal">true</span>&#125;);</span><br><span class="line">    <span class="built_in">console</span>.log(result);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// updateCourseWithUpdatedRecord("5c919cb9310fd622b1db90bd");</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 4 REMOVE Operation - update with new as result</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">removeCourse</span>(<span class="params">id</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// delete the first one found</span></span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> Course.deleteOne(&#123;<span class="attr">_id</span>: id&#125;)</span><br><span class="line">    <span class="comment">// delete all</span></span><br><span class="line">    <span class="comment">// const result = await Course.deleteMany(&#123;isPublished:true&#125;)</span></span><br><span class="line">    <span class="comment">// const course = await Course.findByIdAndRemove(id);</span></span><br><span class="line">    <span class="built_in">console</span>.log(result);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// removeCourse("5c919cb9310fd622b1db90bd");</span></span><br></pre></td></tr></table></figure>
<h3 id="data-validation"><a class="markdownIt-Anchor" href="#data-validation"></a> Data Validation</h3>
<br>
<div class="note warning">
            <p>Validation Happens in Mongoose Level, not in Database Level.</p><div class="note success">            <p>Three Levels of Validation:</p><ol><li>Router Level: Joi</li><li>Mongoose Level: Built-in Validation</li><li>Database Level: MySQL …</li></ol>          </div><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Define the database</span></span><br><span class="line"><span class="keyword">const</span> courseSchema = <span class="keyword">new</span> mongoose.Schema(&#123;</span><br><span class="line">	<span class="comment">// 使得unique生效，必须删除数据库，重启服务，才可以</span></span><br><span class="line">	name: &#123; <span class="attr">type</span>: <span class="built_in">String</span>, <span class="attr">required</span>: <span class="literal">true</span>, <span class="attr">unique</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">	author: <span class="built_in">String</span>,</span><br><span class="line">	tags: [ <span class="built_in">String</span> ], <span class="comment">// this means a list of string</span></span><br><span class="line">	date: &#123; <span class="attr">type</span>: <span class="built_in">Date</span>, <span class="attr">default</span>: <span class="built_in">Date</span>.now &#125;,</span><br><span class="line">    isPublished: <span class="built_in">Boolean</span>,</span><br><span class="line">    price: &#123;<span class="attr">type</span>: <span class="built_in">Number</span>, <span class="attr">required</span>: <span class="literal">true</span>&#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
          </div>
<h4 id="error-handling"><a class="markdownIt-Anchor" href="#error-handling"></a> Error handling</h4>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">createSingleCourse</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">	<span class="comment">// create an instance</span></span><br><span class="line">    <span class="keyword">const</span> course = <span class="keyword">new</span> Course(data);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// return a promise</span></span><br><span class="line">        <span class="keyword">const</span> result = <span class="keyword">await</span> course.save();</span><br><span class="line">    &#125;<span class="keyword">catch</span>(err) &#123;</span><br><span class="line">        <span class="built_in">console</span>.log(err.message);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">createSingleCourse(data1);</span><br><span class="line">createSingleCourse(data2);</span><br></pre></td></tr></table></figure>
<h4 id="built-in-validation"><a class="markdownIt-Anchor" href="#built-in-validation"></a> Built-in Validation</h4>
<br>
<div class="note info">
            <p>Price is only required when it is published</p>
          </div>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> courseSchema = <span class="keyword">new</span> mongoose.Schema(&#123;</span><br><span class="line">	<span class="comment">// 使得unique生效，必须删除数据库，重启服务，才可以</span></span><br><span class="line">    name: &#123; </span><br><span class="line">        type: <span class="built_in">String</span>, </span><br><span class="line">        required: <span class="literal">true</span>, </span><br><span class="line">        unique: <span class="literal">true</span>,</span><br><span class="line">        minlength: <span class="number">5</span>,</span><br><span class="line">        maxlength: <span class="number">150</span>,</span><br><span class="line">        <span class="comment">// match: /^data/i // no need to use this one</span></span><br><span class="line">    &#125;,</span><br><span class="line">    category: &#123;</span><br><span class="line">        type: <span class="built_in">String</span>,</span><br><span class="line">        required: <span class="literal">true</span>,</span><br><span class="line">        enum: [<span class="string">'web'</span>, <span class="string">'mobile'</span>, <span class="string">'network'</span>] <span class="comment">// 固定的几种， 和in差不多</span></span><br><span class="line">    &#125;,</span><br><span class="line">	author: <span class="built_in">String</span>,</span><br><span class="line">	tags: [<span class="built_in">String</span>],</span><br><span class="line">	date: &#123; <span class="attr">type</span>: <span class="built_in">Date</span>, <span class="attr">default</span>: <span class="built_in">Date</span>.now &#125;,</span><br><span class="line">    isPublished: <span class="built_in">Boolean</span>,</span><br><span class="line">    price: &#123;</span><br><span class="line">        type: <span class="built_in">Number</span>, </span><br><span class="line">        required: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;<span class="keyword">return</span> <span class="keyword">this</span>.isPublished&#125;, <span class="comment">// price is only required when it is published</span></span><br><span class="line">        min: <span class="number">10</span>,</span><br><span class="line">        max: <span class="number">100</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h4 id="custom-validation"><a class="markdownIt-Anchor" href="#custom-validation"></a> Custom Validation</h4>
<br>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Define the database</span></span><br><span class="line"><span class="keyword">const</span> courseSchema = <span class="keyword">new</span> mongoose.Schema(&#123;</span><br><span class="line">	<span class="comment">// 使得unique生效，必须删除数据库，重启服务，才可以</span></span><br><span class="line">    name: &#123; </span><br><span class="line">        type: <span class="built_in">String</span>, </span><br><span class="line">        required: <span class="literal">true</span>, </span><br><span class="line">        unique: <span class="literal">true</span>,</span><br><span class="line">        minlength: <span class="number">5</span>,</span><br><span class="line">        maxlength: <span class="number">150</span>,</span><br><span class="line">        <span class="comment">// match: /^data/i // no need to use this one</span></span><br><span class="line">    &#125;,</span><br><span class="line">    category: &#123;</span><br><span class="line">        type: <span class="built_in">String</span>,</span><br><span class="line">        required: <span class="literal">true</span>,</span><br><span class="line">        enum: [<span class="string">'web'</span>, <span class="string">'mobile'</span>, <span class="string">'network'</span>] <span class="comment">// 固定的几种， 和in差不多</span></span><br><span class="line">    &#125;,</span><br><span class="line">	author: <span class="built_in">String</span>,</span><br><span class="line">	tags: &#123;</span><br><span class="line">        type: <span class="built_in">Array</span>,</span><br><span class="line">        validate: &#123;</span><br><span class="line">            validator: <span class="function"><span class="keyword">function</span>(<span class="params">v</span>) </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> v &amp;&amp; v.length &gt; <span class="number">0</span>;</span><br><span class="line">            &#125;,</span><br><span class="line">            message: <span class="string">"A course at least has one tag"</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;,</span><br><span class="line">	date: &#123; <span class="attr">type</span>: <span class="built_in">Date</span>, <span class="attr">default</span>: <span class="built_in">Date</span>.now &#125;,</span><br><span class="line">    isPublished: <span class="built_in">Boolean</span>,</span><br><span class="line">    price: &#123;</span><br><span class="line">        type: <span class="built_in">Number</span>, </span><br><span class="line">        required: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;<span class="keyword">return</span> <span class="keyword">this</span>.isPublished&#125;, <span class="comment">// price is only required when it is published</span></span><br><span class="line">        min: <span class="number">10</span>,</span><br><span class="line">        max: <span class="number">100</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h4 id="async-validation"><a class="markdownIt-Anchor" href="#async-validation"></a> <span class="exturl" data-url="aHR0cHM6Ly9tb25nb29zZWpzLmNvbS9kb2NzL3ZhbGlkYXRpb24uaHRtbCNhc3luYy1jdXN0b20tdmFsaWRhdG9ycw==" title="https://mongoosejs.com/docs/validation.html#async-custom-validators">Async Validation<i class="fa fa-external-link"></i></span></h4>
<br>
<div class="note ">
            <p>What if you need to call another api during the validation?</p><div class="note success">            <p>The Answer is the <code>callback</code> function</p>          </div>
          </div>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Define the database</span></span><br><span class="line"><span class="keyword">const</span> courseSchema = <span class="keyword">new</span> mongoose.Schema(&#123;</span><br><span class="line">	<span class="comment">// 使得unique生效，必须删除数据库，重启服务，才可以</span></span><br><span class="line">    name: &#123; </span><br><span class="line">        type: <span class="built_in">String</span>, </span><br><span class="line">        required: <span class="literal">true</span>, </span><br><span class="line">        unique: <span class="literal">true</span>,</span><br><span class="line">        minlength: <span class="number">5</span>,</span><br><span class="line">        maxlength: <span class="number">150</span>,</span><br><span class="line">        <span class="comment">// match: /^data/i // no need to use this one</span></span><br><span class="line">    &#125;,</span><br><span class="line">    category: &#123;</span><br><span class="line">        type: <span class="built_in">String</span>,</span><br><span class="line">        required: <span class="literal">true</span>,</span><br><span class="line">        enum: [<span class="string">'web'</span>, <span class="string">'mobile'</span>, <span class="string">'network'</span>] <span class="comment">// 固定的几种， 和in差不多</span></span><br><span class="line">    &#125;,</span><br><span class="line">	author: <span class="built_in">String</span>,</span><br><span class="line">	tags: &#123;</span><br><span class="line">        type: <span class="built_in">Array</span>,</span><br><span class="line">        validate: &#123;</span><br><span class="line">            isAsync: <span class="literal">true</span>,</span><br><span class="line">            validator: <span class="function"><span class="keyword">function</span>(<span class="params">v, callback</span>) </span>&#123;</span><br><span class="line">                setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">                    <span class="keyword">const</span> result =  v &amp;&amp; v.length &gt; <span class="number">0</span>;</span><br><span class="line">                    callback(result);</span><br><span class="line">                &#125;, <span class="number">2000</span>);</span><br><span class="line">            &#125;,</span><br><span class="line">            message: <span class="string">"A course at least has one tag"</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;,</span><br><span class="line">	date: &#123; <span class="attr">type</span>: <span class="built_in">Date</span>, <span class="attr">default</span>: <span class="built_in">Date</span>.now &#125;,</span><br><span class="line">    isPublished: <span class="built_in">Boolean</span>,</span><br><span class="line">    price: &#123;</span><br><span class="line">        type: <span class="built_in">Number</span>, </span><br><span class="line">        required: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;<span class="keyword">return</span> <span class="keyword">this</span>.isPublished&#125;, <span class="comment">// price is only required when it is published</span></span><br><span class="line">        min: <span class="number">10</span>,</span><br><span class="line">        max: <span class="number">100</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="mongoose"><a class="markdownIt-Anchor" href="#mongoose"></a> Mongoose</h2>
<h3 id="connect-document"><a class="markdownIt-Anchor" href="#connect-document"></a> Connect Document</h3>
<ul>
<li>References (normalization)</li>
</ul>
 <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> author = &#123;</span><br><span class="line">    name:<span class="string">"James"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> course = &#123;</span><br><span class="line">    author: <span class="string">'id'</span> <span class="comment">// id is the reference to James.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>Embedded Documents (denormalization)</li>
</ul>
 <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> course = &#123;</span><br><span class="line">    auther : &#123;</span><br><span class="line">        name: James</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>Hybrid Approach
<ul>
<li>useful when you want to snasx492021</li>
</ul>
</li>
</ul>
 <figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> author = &#123;</span><br><span class="line">    name： <span class="string">"James"</span>,</span><br><span class="line">   <span class="comment">//  other 50 properties</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> course = &#123;</span><br><span class="line">    author: &#123;</span><br><span class="line">        id: <span class="string">'ref'</span>,   <span class="comment">// embedeed approach</span></span><br><span class="line">        name: <span class="string">"James"</span>  <span class="comment">// reference approach</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>Compare:
<ul>
<li>Reference can ensure consistence but low performance.</li>
<li>Embedded method can ensure high performance but low consistency.</li>
<li>Consistency means every time you update the author data, all the same record elsewhere are also updated.</li>
<li>Reference use <code>central store</code> to keep consistence. But every time you query course, you have to query the auther once which reduce the performance.</li>
</ul>
</li>
</ul>
<h3 id="reference-document"><a class="markdownIt-Anchor" href="#reference-document"></a> Reference Document</h3>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Course = mongoose.model(<span class="string">'Course'</span>,<span class="keyword">new</span> mongoose.Schema(&#123;</span><br><span class="line">    name: <span class="built_in">String</span>,</span><br><span class="line">    author: &#123;</span><br><span class="line">        type: mongoose.Schema.Types.ObejctId,</span><br><span class="line">        ref: <span class="string">'Author'</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;))</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">createCourse</span>(<span class="params">name, author</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">const</span> course = <span class="keyword">new</span> Course(&#123;</span><br><span class="line">		name,</span><br><span class="line">		author</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">createCourse(<span class="string">'James'</span>, <span class="string">'authorID'</span>); </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">listCourses</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="keyword">const</span> courses = <span class="keyword">await</span> Course.find().select(<span class="string">'name'</span>);</span><br><span class="line">	<span class="built_in">console</span>.log(courses);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="populate-method"><a class="markdownIt-Anchor" href="#populate-method"></a> Populate Method</h3>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">listCourses</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="keyword">const</span> courses = <span class="keyword">await</span> Course.find().select(<span class="string">'name author'</span>);</span><br><span class="line">	<span class="built_in">console</span>.log(courses);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// here you only got an id</span></span><br><span class="line">listCourses();</span><br></pre></td></tr></table></figure>
<ul>
<li>if you want the <code>entire</code> author obejct</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">listCourses</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> courses = <span class="keyword">await</span> Course.find()</span><br><span class="line">    .populate(<span class="string">'author'</span>)</span><br><span class="line">    .select(<span class="string">'name author'</span>); <span class="comment">// seperate by space</span></span><br><span class="line">	<span class="built_in">console</span>.log(courses);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// here you only got the entire author obejct</span></span><br><span class="line">listCourses();</span><br></pre></td></tr></table></figure>
<ul>
<li>if you only want name property for author object`</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">listCourse</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> courses = <span class="keyword">await</span> Course.find()</span><br><span class="line">    .populate(<span class="string">'author'</span>,<span class="string">'name -_id'</span>) <span class="comment">// core code</span></span><br><span class="line">    .populate(<span class="string">'category'</span>, <span class="string">'name'</span>)</span><br><span class="line">    .select(<span class="string">'name author'</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(courses);</span><br><span class="line">&#125;</span><br><span class="line">listCourse();</span><br></pre></td></tr></table></figure>
<h3 id="embedded-document"><a class="markdownIt-Anchor" href="#embedded-document"></a> Embedded Document</h3>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> authorSchema = <span class="keyword">new</span> mongoose.Schema(&#123;</span><br><span class="line">  name: <span class="built_in">String</span>,</span><br><span class="line">  bio: <span class="built_in">String</span>,</span><br><span class="line">  website: <span class="built_in">String</span></span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">const</span> Author = mongoose.model(<span class="string">'Author'</span>, authorSchema);</span><br><span class="line"></span><br><span class="line"><span class="comment">// core code: schema in schema</span></span><br><span class="line"><span class="keyword">const</span> Course = mongoose.model(<span class="string">'Course'</span>, <span class="keyword">new</span> mongoose.Schema(&#123;</span><br><span class="line">  name: <span class="built_in">String</span>,</span><br><span class="line">  author: authorSchema</span><br><span class="line">&#125;));</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">createCourse</span>(<span class="params">name, author</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> course = <span class="keyword">new</span> Course(&#123;</span><br><span class="line">    name, </span><br><span class="line">    author: authorSchema</span><br><span class="line">  &#125;); </span><br><span class="line">  </span><br><span class="line">  <span class="keyword">const</span> result = <span class="keyword">await</span> course.save();</span><br><span class="line">  <span class="built_in">console</span>.log(result);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">createCourse(<span class="string">'The Secret'</span>, <span class="keyword">new</span> Author(&#123;<span class="attr">name</span>: <span class="string">'James'</span>&#125;));</span><br></pre></td></tr></table></figure>
<h3 id="remove-item-in-an-array"><a class="markdownIt-Anchor" href="#remove-item-in-an-array"></a> Remove item in an array</h3>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">removeAuthor</span>(<span class="params">courseId, authorId</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> course = <span class="keyword">await</span> Course.findById(courseId);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// core code</span></span><br><span class="line">    <span class="keyword">const</span> author = course.authors.id(authorId);</span><br><span class="line">    author.remove();</span><br><span class="line">    <span class="comment">// core code</span></span><br><span class="line"></span><br><span class="line">    course.save();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="validate-object-id"><a class="markdownIt-Anchor" href="#validate-object-id"></a> Validate Object Id</h3>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yarn joi</span><br><span class="line">yarn add joi-objectid</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// import joi-objectid</span></span><br><span class="line"><span class="keyword">const</span> Joi = <span class="built_in">require</span>(<span class="string">'joi'</span>);</span><br><span class="line">Joi.obejctId = <span class="built_in">require</span>(<span class="string">'joi-objectid'</span>)(Joi);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">validateId</span>(<span class="params">rental</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> schema = &#123;</span><br><span class="line">        <span class="comment">// customerId: Joi.string().required();</span></span><br><span class="line">        <span class="comment">// core code</span></span><br><span class="line">        customerId: Joi.objectId().required();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Joi.validate(rental, schema);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="transactions-two-phase-commit"><a class="markdownIt-Anchor" href="#transactions-two-phase-commit"></a> Transactions &amp;&amp; Two-Phase Commit</h3>
<ul>
<li>Transaction: several operations as a unit in relational database.</li>
<li>Two-phase Commit: the same idea in Mongo DB</li>
<li>Tool: <code>yarn add fawn</code></li>
</ul>
<h2 id="authentication-authorization"><a class="markdownIt-Anchor" href="#authentication-authorization"></a> Authentication &amp; Authorization</h2>
<h3 id="concepts"><a class="markdownIt-Anchor" href="#concepts"></a> Concepts:</h3>
<ul>
<li>Authentication: Registered user</li>
<li>Authorization: right access for some operations</li>
</ul>
<h3 id="auth-flow"><a class="markdownIt-Anchor" href="#auth-flow"></a> Auth Flow</h3>
<p><img style="width: 100%; margin: auto" src="https://geekeaskblogpics.s3-ap-southeast-2.amazonaws.com/posts/WX20190602-220152.png"></p>
<h3 id="user-model"><a class="markdownIt-Anchor" href="#user-model"></a> User Model</h3>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ./models/user</span></span><br><span class="line"><span class="keyword">const</span> config = <span class="built_in">require</span>(<span class="string">'config'</span>);</span><br><span class="line"><span class="keyword">const</span> jwt = <span class="built_in">require</span>(<span class="string">'jsonwebtoken'</span>);</span><br><span class="line"><span class="keyword">const</span> Joi = <span class="built_in">require</span>(<span class="string">'joi'</span>);</span><br><span class="line"><span class="keyword">const</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> userSchema = <span class="keyword">new</span> mongoose.Schema(&#123;</span><br><span class="line">    ...</span><br><span class="line">    isAdmin: <span class="built_in">Boolean</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// instance method is defined in schema level.</span></span><br><span class="line">userSchema.methods.generateAuthToken = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> token = jwt.sign(&#123; </span><br><span class="line">        _id: <span class="keyword">this</span>._id, </span><br><span class="line">        isAdmin: <span class="keyword">this</span>.isAdmin &#125;, config.get(<span class="string">'jwtPrivateKey'</span>));</span><br><span class="line">	<span class="keyword">return</span> token;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> User = mongoose.model(<span class="string">'User'</span>, userSchema);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">validateUser</span>(<span class="params">user</span>) </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">exports.User = User;</span><br><span class="line">exports.validate = validateUser;</span><br></pre></td></tr></table></figure>
<h3 id="user-router"><a class="markdownIt-Anchor" href="#user-router"></a> User Router</h3>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ./routes/users.js</span></span><br><span class="line"><span class="keyword">const</span> auth = <span class="built_in">require</span>(<span class="string">'../middleware/auth'</span>);</span><br><span class="line"><span class="keyword">const</span> jwt = <span class="built_in">require</span>(<span class="string">'jsonwebtoken'</span>);</span><br><span class="line"><span class="keyword">const</span> config = <span class="built_in">require</span>(<span class="string">'config'</span>);</span><br><span class="line"><span class="keyword">const</span> bcrypt = <span class="built_in">require</span>(<span class="string">'bcrypt'</span>);</span><br><span class="line"><span class="keyword">const</span> _ = <span class="built_in">require</span>(<span class="string">'lodash'</span>);</span><br><span class="line"><span class="keyword">const</span> &#123; User, validate &#125; = <span class="built_in">require</span>(<span class="string">'../models/user'</span>);</span><br><span class="line"><span class="keyword">const</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>);</span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">const</span> router = express.Router();</span><br><span class="line"></span><br><span class="line">router.get(<span class="string">'/me'</span>, auth, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">	<span class="keyword">const</span> user = <span class="keyword">await</span> User.findById(req.user._id).select(<span class="string">'-password'</span>);</span><br><span class="line">	res.send(user);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">router.post(<span class="string">'/'</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">	<span class="keyword">const</span> &#123; error &#125; = validate(req.body);</span><br><span class="line">	<span class="keyword">if</span> (error) <span class="keyword">return</span> res.status(<span class="number">400</span>).send(error.details[<span class="number">0</span>].message);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">let</span> user = <span class="keyword">await</span> User.findOne(&#123; <span class="attr">email</span>: req.body.email &#125;);</span><br><span class="line">	<span class="keyword">if</span> (user) <span class="keyword">return</span> res.status(<span class="number">400</span>).send(<span class="string">'User already registered.'</span>);</span><br><span class="line"></span><br><span class="line">	user = <span class="keyword">new</span> User(_.pick(req.body, [ <span class="string">'name'</span>, <span class="string">'email'</span>, <span class="string">'password'</span> ]));</span><br><span class="line">	<span class="keyword">const</span> salt = <span class="keyword">await</span> bcrypt.genSalt(<span class="number">10</span>);</span><br><span class="line">	user.password = <span class="keyword">await</span> bcrypt.hash(user.password, salt);</span><br><span class="line">	<span class="keyword">await</span> user.save();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">const</span> token = user.generateAuthToken();</span><br><span class="line">	res.header(<span class="string">'x-auth-token'</span>, token).send(_.pick(user, [ <span class="string">'_id'</span>, <span class="string">'name'</span>, <span class="string">'email'</span> ]));</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = router;</span><br></pre></td></tr></table></figure>
<h3 id="auth-router"><a class="markdownIt-Anchor" href="#auth-router"></a> Auth Router</h3>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Joi = <span class="built_in">require</span>(<span class="string">'joi'</span>);</span><br><span class="line"><span class="keyword">const</span> bcrypt = <span class="built_in">require</span>(<span class="string">'bcrypt'</span>);</span><br><span class="line"><span class="keyword">const</span> _ = <span class="built_in">require</span>(<span class="string">'lodash'</span>);</span><br><span class="line"><span class="keyword">const</span> &#123;User&#125; = <span class="built_in">require</span>(<span class="string">'../models/user'</span>);</span><br><span class="line"><span class="keyword">const</span> mongoose = <span class="built_in">require</span>(<span class="string">'mongoose'</span>);</span><br><span class="line"><span class="keyword">const</span> express = <span class="built_in">require</span>(<span class="string">'express'</span>);</span><br><span class="line"><span class="keyword">const</span> router = express.Router();</span><br><span class="line"></span><br><span class="line">router.post(<span class="string">'/'</span>, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; error &#125; = validate(req.body); </span><br><span class="line">  <span class="keyword">if</span> (error) <span class="keyword">return</span> res.status(<span class="number">400</span>).send(error.details[<span class="number">0</span>].message);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> user = <span class="keyword">await</span> User.findOne(&#123; <span class="attr">email</span>: req.body.email &#125;);</span><br><span class="line">  <span class="keyword">if</span> (!user) <span class="keyword">return</span> res.status(<span class="number">400</span>).send(<span class="string">'Invalid email or password.'</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> validPassword = <span class="keyword">await</span> bcrypt.compare(req.body.password, user.password);</span><br><span class="line">  <span class="keyword">if</span> (!validPassword) <span class="keyword">return</span> res.status(<span class="number">400</span>).send(<span class="string">'Invalid email or password.'</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> token = user.generateAuthToken();</span><br><span class="line">  res.send(token);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">validate</span>(<span class="params">req</span>) </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = router;</span><br></pre></td></tr></table></figure>
<h3 id="auth-middleware"><a class="markdownIt-Anchor" href="#auth-middleware"></a> Auth Middleware</h3>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> jwt = <span class="built_in">require</span>(<span class="string">'jsonwebtoken'</span>);</span><br><span class="line"><span class="keyword">const</span> config = <span class="built_in">require</span>(<span class="string">'config'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> token = req.header(<span class="string">'x-auth-token'</span>);</span><br><span class="line">  <span class="keyword">if</span> (!token) <span class="keyword">return</span> res.status(<span class="number">401</span>).send(<span class="string">'Access denied. No token provided.'</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> decoded = jwt.verify(token, config.get(<span class="string">'jwtPrivateKey'</span>));</span><br><span class="line">    req.user = decoded; </span><br><span class="line">    next();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span> (ex) &#123;</span><br><span class="line">    res.status(<span class="number">400</span>).send(<span class="string">'Invalid token.'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="admin-middleware"><a class="markdownIt-Anchor" href="#admin-middleware"></a> Admin Middleware</h3>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span> (<span class="params">req, res, next</span>) </span>&#123; </span><br><span class="line">  <span class="comment">// 401 Unauthorized</span></span><br><span class="line">  <span class="comment">// 403 Forbidden </span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (!req.user.isAdmin) <span class="keyword">return</span> res.status(<span class="number">403</span>).send(<span class="string">'Access denied.'</span>);</span><br><span class="line"></span><br><span class="line">  next();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="add-auth-to-router"><a class="markdownIt-Anchor" href="#add-auth-to-router"></a> Add Auth to Router</h3>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">app.use(<span class="string">'/some-route'</span>, auth, ()=&gt; &#123;</span><br><span class="line">    <span class="comment">// example function</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">router.user(<span class="string">'/some-route'</span>, auth, () =&gt; &#123;</span><br><span class="line">    <span class="comment">// example function</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="lodash-a-improve-version-of-underscore"><a class="markdownIt-Anchor" href="#lodash-a-improve-version-of-underscore"></a> Lodash - a improve version of Underscore</h3>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add lodash</span><br></pre></td></tr></table></figure>
<ul>
<li>Typically</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">user = <span class="keyword">new</span> User(&#123;</span><br><span class="line">    name: req.body.name, </span><br><span class="line">    email: req.body.email, </span><br><span class="line">    password: req.body.password&#125;);</span><br><span class="line"></span><br><span class="line">res.send(&#123;</span><br><span class="line">    name: user.name,</span><br><span class="line">    email: user.email,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<ul>
<li>Better way</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> _ = <span class="built_in">require</span>(<span class="string">'lodash'</span>);</span><br><span class="line"></span><br><span class="line">user = <span class="keyword">new</span> User(_.pick(req.body, [<span class="string">'name'</span>,<span class="string">'email'</span>,<span class="string">'password'</span>]));</span><br><span class="line">res.send(_.pick(user,[<span class="string">'_id'</span>,<span class="string">'name'</span>,<span class="string">'email'</span>]));</span><br></pre></td></tr></table></figure>
<h3 id="enforce-password-complexity"><a class="markdownIt-Anchor" href="#enforce-password-complexity"></a> <span class="exturl" data-url="aHR0cHM6Ly93d3cubnBtanMuY29tL3BhY2thZ2Uvam9pLXBhc3N3b3JkLWNvbXBsZXhpdHk=" title="https://www.npmjs.com/package/joi-password-complexity">Enforce Password Complexity<i class="fa fa-external-link"></i></span></h3>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add joi-password-complexity</span><br></pre></td></tr></table></figure>
<h3 id="hashing-password"><a class="markdownIt-Anchor" href="#hashing-password"></a> Hashing Password</h3>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add bcrypt</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// bcrypt 加密</span></span><br><span class="line"><span class="keyword">const</span> salt = <span class="keyword">await</span> bcrypt.genSalt(<span class="number">10</span>);</span><br><span class="line"><span class="keyword">const</span> password = <span class="keyword">await</span> bcrypt.hash(user.password, salt);</span><br><span class="line"><span class="comment">// bcrypt 验密</span></span><br><span class="line"><span class="keyword">const</span> validPassword = <span class="keyword">await</span> bcrypt.compare(req.body.password, password);</span><br></pre></td></tr></table></figure>
<ul>
<li>Then we should store the <code>hashed</code> password into database.</li>
</ul>
<h3 id="jwt"><a class="markdownIt-Anchor" href="#jwt"></a> <span class="exturl" data-url="aHR0cHM6Ly9qd3QuaW8v" title="https://jwt.io/">JWT<i class="fa fa-external-link"></i></span></h3>
<ul>
<li>For auth router, this time we return a string instead of <code>true</code> or <code>invalid password</code>.</li>
<li>The JWT will store in <code>localstorage</code> for <code>future access</code> to api.</li>
<li><span class="exturl" data-url="aHR0cHM6Ly93d3cudWRlbXkuY29tL25vZGVqcy1tYXN0ZXItY2xhc3MvbGVhcm4vbGVjdHVyZS85OTkzNDg2I292ZXJ2aWV3" title="https://www.udemy.com/nodejs-master-class/learn/lecture/9993486#overview">More<i class="fa fa-external-link"></i></span></li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add jsonwebtoken</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Generate and send Token</span></span><br><span class="line"><span class="keyword">const</span> token = jwt.sign(&#123; <span class="attr">_id</span>: <span class="keyword">this</span>._id&#125;, <span class="string">"privateKey"</span>);</span><br><span class="line">res.header(<span class="string">'auth-token'</span>, token).send();</span><br><span class="line"></span><br><span class="line"><span class="comment">// verify token</span></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> decoded = jwt.verify(token, config.get(<span class="string">'jwtPrivateKey'</span>));</span><br><span class="line">&#125;<span class="keyword">catch</span>(err) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"Access Denied."</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="set-jwt-private-key-in-environment-variable"><a class="markdownIt-Anchor" href="#set-jwt-private-key-in-environment-variable"></a> Set JWT Private Key in Environment Variable</h3>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yarn add config</span><br></pre></td></tr></table></figure>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// config/default.json</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"jwtPrivateKey"</span>: <span class="string">"anything"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>mapping bewtween setting name and env var name</li>
</ul>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> vidly_jwtPrivateKey=anything</span><br></pre></td></tr></table></figure>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// config/custom-environment-variables.json</span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">"jwtPrivateKey"</span>: <span class="string">"vidly_jwtPrivateKey"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="set-token-in-response-header"><a class="markdownIt-Anchor" href="#set-token-in-response-header"></a> Set Token in Response Header</h3>
<ul>
<li>
<p>We want to give the user the JWT token after they registering.</p>
</li>
<li>
<p>Assume users don’t have to do email confirmation after registration.</p>
</li>
<li>
<p>We will not store the token in reponse.</p>
</li>
<li>
<p>We will store the token in reposne header.</p>
</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> token = jwt.sign(&#123;<span class="attr">_id</span>: user.id&#125;, <span class="string">'anystring'</span>); <span class="comment">// anything should be replaced by environment variable</span></span><br><span class="line">res.header(<span class="string">'x-auth-token'</span>,token).send(_.pick(user,[<span class="string">'_id'</span>,<span class="string">'name'</span>,<span class="string">'email'</span>]));</span><br></pre></td></tr></table></figure>
<h2 id="some-notes"><a class="markdownIt-Anchor" href="#some-notes"></a> Some Notes</h2>
<h3 id="errstack"><a class="markdownIt-Anchor" href="#errstack"></a> err.stack</h3>
<ul>
<li>err.stack: the trace of error</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">console</span>.log(err.stack);</span><br></pre></td></tr></table></figure>
      

      
    </div>

    
      

  <div class="popular-posts-header">Related Posts</div>
  <ul class="popular-posts">
  
    <li class="popular-posts-item">
      
      
      <div class="popular-posts-title"><a href="/importcssreact.html" rel="bookmark">Import Stylesheets into React</a></div>
      
    </li>
  
    <li class="popular-posts-item">
      
      
      <div class="popular-posts-title"><a href="/certificate.html" rel="bookmark">IT Courses List</a></div>
      
    </li>
  
    <li class="popular-posts-item">
      
      
      <div class="popular-posts-title"><a href="/css3.html" rel="bookmark">CSS3 New Features</a></div>
      
    </li>
  
    <li class="popular-posts-item">
      
      
      <div class="popular-posts-title"><a href="/cssdisplay.html" rel="bookmark">CSS block inline inline-block</a></div>
      
    </li>
  
  </ul>


    

    
    
    

    
      <div id="wechat_subscriber" style="display: block; padding: 60px 0 0; margin: auto; width: 100%; text-align: center;">
  <img id="wechat_subscriber_qcode" src="/uploads/images/zeng.jpg" alt="James Tan wechat" style="width: 14em; max-width: 100%;">
  <div style="margin-top: 20px">人工智能学习资源 欢迎订阅我的公众号</div>
</div>

    

    
      
    
    

    

    <footer class="post-footer">

      
        <div class="post-tags">
          
            <a href="/tags/Frontend/" rel="tag"># Frontend</a>
          
            <a href="/tags/Restful-API/" rel="tag"># Restful API</a>
          
            <a href="/tags/Nodejs/" rel="tag"># Nodejs</a>
          
        </div>
      

      
      
        <div class="post-widgets">
        
          <div class="wp_rating">
            <div id="wpac-rating"></div>
          </div>
        

        

        
        </div>
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/backendallinone.html" rel="next" title="后端工程师技术图谱">
                <i class="fa fa-chevron-left"></i> 后端工程师技术图谱
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/git-credential.html" rel="prev" title="Git Push 免输账户密码">
                Git Push 免输账户密码 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div class="comments" id="gitalk-container">
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.jpg" alt="James Tan">
            
              <p class="site-author-name" itemprop="name">James Tan</p>
              <div class="site-description motion-element" itemprop="description">Sharing is the best way to learn.</div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives">
                
                    <span class="site-state-item-count">92</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                      <a href="/categories/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">24</span>
                    <span class="site-state-item-name">categories</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">104</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                  
                    
                  
                  <span class="exturl" data-url="aHR0cHM6Ly9zMy1hcC1zb3V0aGVhc3QtMi5hbWF6b25hd3MuY29tL2dlZWtlYXNrYmxvZ3BpY3MvcG9zdHMvd2VjaGF0Y29udGFjdC5qcGVn" title="Wechat &rarr; https://s3-ap-southeast-2.amazonaws.com/geekeaskblogpics/posts/wechatcontact.jpeg"><i class="fa fa-fw fa-wechat"></i></span>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                  
                    
                  
                  <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0dlZWtFYXN0Lw==" title="GitHub &rarr; https://github.com/GeekEast/"><i class="fa fa-fw fa-github"></i></span>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                  
                    
                  
                  <span class="exturl" data-url="aHR0cHM6Ly93d3cubGlua2VkaW4uY29tL2luL2dlZWt6ZW5nLw==" title="Linkedin &rarr; https://www.linkedin.com/in/geekzeng/"><i class="fa fa-fw fa-linkedin"></i></span>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                  
                    
                  
                  <span class="exturl" data-url="bWFpbHRvOnhpYW5nLnRhbi5wMjEwOUBnbWFpbC5jb20=" title="E-Mail &rarr; mailto:xiang.tan.p2109@gmail.com"><i class="fa fa-fw fa-envelope"></i></span>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                  
                    
                  
                  <span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1plbkdfeGlhbmd0" title="CSDN &rarr; https://blog.csdn.net/ZenG_xiangt"><i class="fa fa-fw fa-contao"></i></span>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                  
                    
                  
                  <a href="/atom.xml" title="RSS &rarr; /atom.xml"><i class="fa fa-fw fa-rss"></i></a>
                </span>
              
            </div>
          

          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-inline">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-heart"></i>
                Links
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://geekeast.github.io/mdtutorial.html" title="https://geekeast.github.io/mdtutorial.html">Hexo Markdown</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <span class="exturl" data-url="aHR0cHM6Ly93d3cuZnJlZWNvZGVjYW1wLm9yZy8=" title="https://www.freecodecamp.org/">Free Code Camp</span>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <span class="exturl" data-url="aHR0cHM6Ly9jc3MtdHJpY2tzLmNvbS8=" title="https://css-tricks.com/">CSS Tricks</span>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <span class="exturl" data-url="aHR0cHM6Ly93d3cudWRlbXkuY29tLw==" title="https://www.udemy.com/">Udemy</span>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://geekeast.github.io/learnitbydoing.html" title="https://geekeast.github.io/learnitbydoing.html">IT Learning Methodology</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <span class="exturl" data-url="aHR0cHM6Ly9hd3MuYW1hem9uLmNvbS9hcmNoaXRlY3R1cmUvP2F3c2YucXVpY2tzdGFydC1hcmNoaXRlY3R1cmUtcGFnZS1maWx0ZXI9aGlnaGxpZ2h0JTIzbmV3" title="https://aws.amazon.com/architecture/?awsf.quickstart-architecture-page-filter=highlight%23new">AWS Architect Center</span>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <span class="exturl" data-url="aHR0cHM6Ly93d3cuZWR1Y2F0aXZlLmlvL3RyYWNrL2FjZS1qYXZhLWNvZGluZy1pbnRlcnZpZXc=" title="https://www.educative.io/track/ace-java-coding-interview">Educative</span>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <span class="exturl" data-url="aHR0cHM6Ly9lZ2doZWFkLmlvLw==" title="https://egghead.io/">EggHead</span>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <span class="exturl" data-url="aHR0cHM6Ly9nZXRib290c3RyYXAuY29tL2RvY3MvNC4xL2NvbnRlbnQvdGFibGVzLw==" title="https://getbootstrap.com/docs/4.1/content/tables/">Bootstrap</span>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <span class="exturl" data-url="aHR0cHM6Ly93d3cudHdpdGNoLnR2Lw==" title="https://www.twitch.tv/">Twitch TV</span>
                  </li>
                
              </ul>
            </div>
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#introduction"><span class="nav-number">1.</span> <span class="nav-text"> Introduction</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#what-is-nodejs"><span class="nav-number">1.1.</span> <span class="nav-text"> What is Node.js?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#where-is-node-from"><span class="nav-number">1.2.</span> <span class="nav-text"> Where is Node from?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#asynchronous-in-nodejs"><span class="nav-number">1.3.</span> <span class="nav-text"> Asynchronous in Node.js</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#what-is-nodejs-used-for"><span class="nav-number">1.4.</span> <span class="nav-text"> What is Node.js used for?</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#install-nodejs"><span class="nav-number">2.</span> <span class="nav-text"> Install Node.js</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#run-nodejs"><span class="nav-number">3.</span> <span class="nav-text"> Run Node.js</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#javascript-module"><span class="nav-number">4.</span> <span class="nav-text"> Javascript Module</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#global-object"><span class="nav-number">4.1.</span> <span class="nav-text"> Global object</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#insights-why-we-need-to-use-module"><span class="nav-number">4.2.</span> <span class="nav-text"> Insights: Why we need to use Module?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#module-import-and-export"><span class="nav-number">4.3.</span> <span class="nav-text"> Module Import and Export</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#node-wrapper"><span class="nav-number">4.4.</span> <span class="nav-text"> Node Wrapper</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#node-modules-api"><span class="nav-number">4.5.</span> <span class="nav-text"> Node Modules API</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#npm"><span class="nav-number">5.</span> <span class="nav-text"> NPM</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#create-npm-project"><span class="nav-number">5.1.</span> <span class="nav-text"> Create NPM Project</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#switch-version-of-npm"><span class="nav-number">5.1.1.</span> <span class="nav-text"> Switch Version of npm</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#create-packagejson-file"><span class="nav-number">5.1.2.</span> <span class="nav-text"> Create package.json file</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#install-node-package"><span class="nav-number">5.1.3.</span> <span class="nav-text"> Install Node Package</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#git-ignore-packages-to-push"><span class="nav-number">5.1.4.</span> <span class="nav-text"> Git Ignore Packages to Push</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#underscorejs"><span class="nav-number">5.1.5.</span> <span class="nav-text"> Underscore.js</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#semantic-versioning"><span class="nav-number">5.1.6.</span> <span class="nav-text"> Semantic Versioning</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#inspect-installed-versions"><span class="nav-number">5.1.7.</span> <span class="nav-text"> Inspect installed versions</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#view-packages"><span class="nav-number">5.1.8.</span> <span class="nav-text"> View Packages</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#update-outdated-packages"><span class="nav-number">5.1.9.</span> <span class="nav-text"> Update outdated packages</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#install-packages-only-for-dev"><span class="nav-number">5.1.10.</span> <span class="nav-text"> Install Packages only for Dev</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#uninstall-packages"><span class="nav-number">5.1.11.</span> <span class="nav-text"> Uninstall Packages</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#global-packages"><span class="nav-number">5.2.</span> <span class="nav-text"> Global Packages</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#npm-registry"><span class="nav-number">5.3.</span> <span class="nav-text"> NPM Registry</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#publish-your-own-package-to-npm-registry"><span class="nav-number">5.3.1.</span> <span class="nav-text"> Publish Your Own Package to NPM Registry</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#updating-your-published-packages"><span class="nav-number">5.3.2.</span> <span class="nav-text"> Updating your Published Packages</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#restful-service"><span class="nav-number">6.</span> <span class="nav-text"> RESTful Service</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#rest-definition"><span class="nav-number">6.1.</span> <span class="nav-text"> REST Definition</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#http-protocol"><span class="nav-number">6.2.</span> <span class="nav-text"> HTTP Protocol</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#http-methods"><span class="nav-number">6.3.</span> <span class="nav-text"> HTTP Methods</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#node-monitor"><span class="nav-number">7.</span> <span class="nav-text"> Node Monitor</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#express-basics"><span class="nav-number">8.</span> <span class="nav-text"> Express Basics</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#get-to-know-express"><span class="nav-number">8.1.</span> <span class="nav-text"> Get to know express</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#install-express"><span class="nav-number">8.2.</span> <span class="nav-text"> Install Express</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#routes"><span class="nav-number">8.3.</span> <span class="nav-text"> Routes</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#example"><span class="nav-number">8.4.</span> <span class="nav-text"> Example</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#middleware-routes"><span class="nav-number">8.5.</span> <span class="nav-text"> Middleware Routes</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#query-string-parameters"><span class="nav-number">8.6.</span> <span class="nav-text"> Query String Parameters</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#http-get-request"><span class="nav-number">8.7.</span> <span class="nav-text"> HTTP Get Request</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#http-post-request"><span class="nav-number">8.8.</span> <span class="nav-text"> HTTP Post Request</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#simple-input-validation"><span class="nav-number">8.8.1.</span> <span class="nav-text"> Simple Input Validation</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#complex-input-validation"><span class="nav-number">8.8.2.</span> <span class="nav-text"> Complex Input Validation</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#reqbody-vs-reqparams"><span class="nav-number">8.8.3.</span> <span class="nav-text"> req.body vs req.params</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#http-update-request"><span class="nav-number">8.9.</span> <span class="nav-text"> HTTP Update Request</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#http-delete-request"><span class="nav-number">8.10.</span> <span class="nav-text"> HTTP Delete Request</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#code-one-genre-vidly"><span class="nav-number">9.</span> <span class="nav-text"> Code One Genre: Vidly</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#advanced-express"><span class="nav-number">10.</span> <span class="nav-text"> Advanced Express</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#middleware"><span class="nav-number">10.1.</span> <span class="nav-text"> Middleware</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#custom-middleware-function"><span class="nav-number">10.1.1.</span> <span class="nav-text"> Custom Middleware function</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#build-in-middlware"><span class="nav-number">10.1.2.</span> <span class="nav-text"> Build-in Middlware</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#third-party-middleware"><span class="nav-number">10.1.3.</span> <span class="nav-text"> Third Party Middleware</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#environment"><span class="nav-number">10.2.</span> <span class="nav-text"> Environment</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#get-the-env-variable-in-javascript"><span class="nav-number">10.2.1.</span> <span class="nav-text"> Get the ENV variable in Javascript</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#set-the-environment-variable-in-shell"><span class="nav-number">10.2.2.</span> <span class="nav-text"> Set the Environment Variable in shell</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#use-config-management-package"><span class="nav-number">10.2.3.</span> <span class="nav-text"> Use Config Management Package</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#debugging"><span class="nav-number">10.3.</span> <span class="nav-text"> Debugging</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#template-engine"><span class="nav-number">10.4.</span> <span class="nav-text"> Template Engine</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#database-integration"><span class="nav-number">10.5.</span> <span class="nav-text"> Database Integration</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#code-one-genre-refractured"><span class="nav-number">11.</span> <span class="nav-text"> Code One Genre: Refractured</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#mongodb"><span class="nav-number">12.</span> <span class="nav-text"> MongoDB</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#configuration"><span class="nav-number">12.1.</span> <span class="nav-text"> Configuration</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#install-mongodb"><span class="nav-number">12.1.1.</span> <span class="nav-text"> Install MongoDB</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#create-data-directory"><span class="nav-number">12.1.2.</span> <span class="nav-text"> Create Data Directory</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#run-mongodb-in-shell"><span class="nav-number">12.1.3.</span> <span class="nav-text"> Run MongoDB in Shell</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#run-mongodb-by-brew"><span class="nav-number">12.1.4.</span> <span class="nav-text"> Run MongoDB by brew</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#mongodb-gui-client"><span class="nav-number">12.2.</span> <span class="nav-text"> MongoDB GUI Client</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#node-to-mongodb"><span class="nav-number">12.3.</span> <span class="nav-text"> Node to MongoDB</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#connect"><span class="nav-number">12.3.1.</span> <span class="nav-text"> Connect</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#define-collections-and-validations"><span class="nav-number">12.3.2.</span> <span class="nav-text"> Define Collections and Validations</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#crud"><span class="nav-number">12.4.</span> <span class="nav-text"> CRUD</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#create-documents"><span class="nav-number">12.4.1.</span> <span class="nav-text"> Create Documents</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#query-documents"><span class="nav-number">12.4.2.</span> <span class="nav-text"> Query Documents</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#update-documents"><span class="nav-number">12.4.3.</span> <span class="nav-text"> Update Documents</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#remove-documents"><span class="nav-number">12.4.4.</span> <span class="nav-text"> Remove Documents</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#code-two-course-crud"><span class="nav-number">12.5.</span> <span class="nav-text"> Code Two Course: CRUD</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#data-validation"><span class="nav-number">12.6.</span> <span class="nav-text"> Data Validation</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#error-handling"><span class="nav-number">12.6.1.</span> <span class="nav-text"> Error handling</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#built-in-validation"><span class="nav-number">12.6.2.</span> <span class="nav-text"> Built-in Validation</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#custom-validation"><span class="nav-number">12.6.3.</span> <span class="nav-text"> Custom Validation</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#async-validation"><span class="nav-number">12.6.4.</span> <span class="nav-text"> Async Validation</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#mongoose"><span class="nav-number">13.</span> <span class="nav-text"> Mongoose</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#connect-document"><span class="nav-number">13.1.</span> <span class="nav-text"> Connect Document</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#reference-document"><span class="nav-number">13.2.</span> <span class="nav-text"> Reference Document</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#populate-method"><span class="nav-number">13.3.</span> <span class="nav-text"> Populate Method</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#embedded-document"><span class="nav-number">13.4.</span> <span class="nav-text"> Embedded Document</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#remove-item-in-an-array"><span class="nav-number">13.5.</span> <span class="nav-text"> Remove item in an array</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#validate-object-id"><span class="nav-number">13.6.</span> <span class="nav-text"> Validate Object Id</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#transactions-two-phase-commit"><span class="nav-number">13.7.</span> <span class="nav-text"> Transactions &amp;&amp; Two-Phase Commit</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#authentication-authorization"><span class="nav-number">14.</span> <span class="nav-text"> Authentication &amp; Authorization</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#concepts"><span class="nav-number">14.1.</span> <span class="nav-text"> Concepts:</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#auth-flow"><span class="nav-number">14.2.</span> <span class="nav-text"> Auth Flow</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#user-model"><span class="nav-number">14.3.</span> <span class="nav-text"> User Model</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#user-router"><span class="nav-number">14.4.</span> <span class="nav-text"> User Router</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#auth-router"><span class="nav-number">14.5.</span> <span class="nav-text"> Auth Router</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#auth-middleware"><span class="nav-number">14.6.</span> <span class="nav-text"> Auth Middleware</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#admin-middleware"><span class="nav-number">14.7.</span> <span class="nav-text"> Admin Middleware</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#add-auth-to-router"><span class="nav-number">14.8.</span> <span class="nav-text"> Add Auth to Router</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#lodash-a-improve-version-of-underscore"><span class="nav-number">14.9.</span> <span class="nav-text"> Lodash - a improve version of Underscore</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#enforce-password-complexity"><span class="nav-number">14.10.</span> <span class="nav-text"> Enforce Password Complexity</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#hashing-password"><span class="nav-number">14.11.</span> <span class="nav-text"> Hashing Password</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#jwt"><span class="nav-number">14.12.</span> <span class="nav-text"> JWT</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#set-jwt-private-key-in-environment-variable"><span class="nav-number">14.13.</span> <span class="nav-text"> Set JWT Private Key in Environment Variable</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#set-token-in-response-header"><span class="nav-number">14.14.</span> <span class="nav-text"> Set Token in Response Header</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#some-notes"><span class="nav-number">15.</span> <span class="nav-text"> Some Notes</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#errstack"><span class="nav-number">15.1.</span> <span class="nav-text"> err.stack</span></a></li></ol></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-paw"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ZenG</span>

  

  
</div>









        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="post-meta-item-icon">
      <i class="fa fa-user"></i>
    </span>
    <span class="site-uv" title="Total Visitors">
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
    </span>
  

  
    <span class="post-meta-divider">|</span>
  

  
    <span class="post-meta-item-icon">
      <i class="fa fa-eye"></i>
    </span>
    <span class="site-pv" title="Total Views">
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
    </span>
  
</div>









        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>







  






  



  
    
    
      
    
  
  <script color="0,3,255" opacity="0.8" zindex="-1" count="99" src="//cdn.jsdelivr.net/gh/theme-next/theme-next-canvas-nest@1/canvas-nest-nomobile.min.js"></script>











  



  
  <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>

  
  <script src="//cdnjs.cloudflare.com/ajax/libs/jquery_lazyload/1.9.7/jquery.lazyload.min.js"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script src="//cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.6/jquery.fancybox.min.js"></script>

  
  <script src="//cdn.jsdelivr.net/gh/theme-next/theme-next-reading-progress@1/reading_progress.min.js"></script>


  


  <script src="/js/src/utils.js?v=7.0.1"></script>

  <script src="/js/src/motion.js?v=7.0.1"></script>



  
  


  <script src="/js/src/affix.js?v=7.0.1"></script>

  <script src="/js/src/schemes/pisces.js?v=7.0.1"></script>



  
  <script src="/js/src/scrollspy.js?v=7.0.1"></script>
<script src="/js/src/post-details.js?v=7.0.1"></script>



  


  <script src="/js/src/next-boot.js?v=7.0.1"></script>


  
  
  
    
  

  

  
  
  

  


  
    

  

<script src="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>



  

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">



<script src="//cdn.jsdelivr.net/npm/js-md5@0.7.3/src/md5.min.js"></script>

<script>
  var gitalk = new Gitalk({
    clientID: 'e3bc82557deb4539bea0',
    clientSecret: 'ccd5f13f3f7cba21085500585cfc05da2591baf4',
    repo: 'blog_comment',
    owner: 'GeekEast',
    admin: ['GeekEast'],
    id: md5(location.pathname),
    
      language: 'en',
    
    distractionFreeMode: 'false'
  });
  gitalk.render('gitalk-container');
</script>

  


  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('5');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  

  

  
  <script>
    wpac_init = window.wpac_init || [];
    wpac_init.push({
      widget: 'Rating',
      id: 17170,
      el: 'wpac-rating',
      color: 'fc6423'
    });
    (function() {
      if ('WIDGETPACK_LOADED' in window) return;
      WIDGETPACK_LOADED = true;
      var mc = document.createElement('script');
      mc.type = 'text/javascript';
      mc.async = true;
      mc.src = '//embed.widgetpack.com/widget.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(mc, s.nextSibling);
    })();
  </script>


  

  
  <script src="/js/src/js.cookie.js?v=7.0.1"></script>
  <script src="/js/src/scroll-cookie.js?v=7.0.1"></script>


  
  <script src="/js/src/exturl.js?v=7.0.1"></script>


  

  
  <style>
    .copy-btn {
      display: inline-block;
      padding: 6px 12px;
      font-size: 13px;
      font-weight: 700;
      line-height: 20px;
      color: #333;
      white-space: nowrap;
      vertical-align: middle;
      cursor: pointer;
      
        background-color: #eee;
        background-image: linear-gradient(#fcfcfc, #eee);
        border: 1px solid #d5d5d5;
        border-radius: 3px;
      
      user-select: none;
      outline: 0;
    }

    .highlight-wrap .copy-btn {
      transition: opacity .3s ease-in-out;
      opacity: 0;
      padding: 2px 6px;
      position: absolute;
      
        right: 4px;
        top: 8px;
      
    }

    .highlight-wrap:hover .copy-btn,
    .highlight-wrap .copy-btn:focus {
      opacity: 1;
    }

    .highlight-wrap {
      position: relative;
    }
  </style>
  <script>
    $('.highlight').each(function(i, e) {
      var $wrap = $('<div>').addClass('highlight-wrap');
      $(e).after($wrap);
      $wrap.append($('<button>').addClass('copy-btn').append('Copy').on('click', function(e) {
        var code = $(this).parent().find('.code').find('.line').map(function(i, e) {
          return $(e).text();
        }).toArray().join('\n');
        var ta = document.createElement('textarea');
        var yPosition = window.pageYOffset || document.documentElement.scrollTop;
        ta.style.top = yPosition + 'px'; // Prevent page scroll
        ta.style.position = 'absolute';
        ta.style.opacity = '0';
        ta.readOnly = true;
        ta.value = code;
        document.body.appendChild(ta);
        ta.select();
        ta.setSelectionRange(0, code.length);
        ta.readOnly = false;
        var result = document.execCommand('copy');
        
          if (result) $(this).text('Copied');
          else $(this).text('Copy failed');
        
        ta.blur(); // For iOS
        $(this).blur();
      })).on('mouseleave', function(e) {
        var $b = $(this).find('.copy-btn');
        setTimeout(function() {
          $b.text('Copy');
        }, 300);
      }).append(e);
    })
  </script>


<script src="/live2dw/lib/L2Dwidget.min.js?0c58a1486de42ac6cc1c59c7d98ae887"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"/live2dw/assets/wanko.model.json"},"display":{"superSample":2,"width":125,"height":125,"position":"right","hOffset":-20,"vOffset":-20},"mobile":{"show":false}});</script></body>
</html>
